<%= javascript_include_tag 'standard_datatable' %>
<% third_level_breadcrumb("Forms", forms_path, @identifier, @close_path, "Changes:") %>
<h3>Changes: <%= @results[:identifier] %></h3>
<style>
	<%= Diffy::CSS %>
</style>
<div class="col-md-12">
  <h4>Parent Changes</h4>  
  <table id="main" class="table table-striped table-bordered table-condensed">
	  <thead>
			<tr>
				<th>Version</th>
        <% @results[:changes].first[:differences][:results].each do |k, v| %>
          <th><%= k %></th>
        <% end %>
			</tr>
		</thead>
		<tbody>
      <% @results[:changes].each do |result| %>
        <tr>
          <td><%= result[:scoped_identifier][:semantic_version] %></td>
          <% @results[:changes].first[:differences][:results].each do |k, v| %>
            <% entry = result[:differences][:results][k] %>
            <%= diff_glyphicon(entry) %>
          <% end %>
        </tr>
      <% end %>
		</tbody>
	</table>
  <h4>Child Changes</h4>  
  <table id="secondary" class="table table-striped table-bordered table-condensed">
    <thead>
      <tr>
        <% if @results[:child_property].upcase != "ORDINAL" && !@results[:child_keys].first.last[:ordinal].blank? %>
          <th class="fit">Ordinal</th>
        <% end %>
        <th class="fit"><%= @results[:child_property] %></th>
        <% if @results[:child_property].upcase != "LABEL" %>
          <th>Label</th>
        <% end %>
        <% @results[:versions].each do |v| %>
          <th><%= v %></th>
        <% end %>
        <th class="fit"></th>
      </tr>
    </thead>
    <tbody>
      <% @results[:child_keys].each do |k, x| %>
        <tr>
          <% if @results[:child_property].upcase != "ORDINAL" && !@results[:child_keys].first.last[:ordinal].blank? %>
            <td><%= x[:ordinal] %></th>
          <% end %>
          <td><%= k %></td>
          <% if @results[:child_property].upcase != "LABEL" %>
            <td><%= x[:label] %></td>
          <% end %>
          <% @results[:changes].each do |result| %>
            <% entry = result[:differences][:children].find { |c, v| v[@results[:child_property].to_sym] == k } %>
            <% if !entry.nil? %>
              <%= render partial: "shared/change_status", locals: {status: entry.last[:status]} %>
            <% else %>
              <td>&nbsp;</td>
            <% end %>            
          <% end %>
          <td><%= link_to "Changes", changes_iso_concept_index_path(iso_concept: {concepts: x[:children], versions: @results[:versions], child_property: @results[:child_property], identifier: @results[:identifier]}), :class => "btn btn-primary btn-xs" %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
  <%= link_to "Close", @close_path, :class => "btn btn-primary" %>
</div>
