<%= stylesheet_link_tag "custom/status_page" %>

<% if @index_label == "" %>
	<% second_level_breadcrumb(@managed_item.identifier, @close_path, "Status:") %>
<% else %>
	<% third_level_managed_item_breadcrumb(@managed_item, @index_label, @index_path, @close_path, "Status:") %>
<% end %>

<% state = @registration_state.registrationStatus %>
<% nextState = IsoRegistrationState.nextState(@registration_state.registrationStatus) %>

<div class="row">
  <%= render layout: "shared/iso_managed/managed_header_card", :locals => {:item => @managed_item, :badge => get_iso_managed_icon(@managed_item), :header_title => "Item management" } do %>
    <div class="actions-wrap">
			<%= render partial: "shared/buttons/ico_btn_secondary", :locals => {link_path: @close_path, id: "close",
				icon: "icon-long-arrow", btn_text: "Return", dt_toggle: "", disabled: false } %>
    </div>
  <% end %>
</div>
<div class="row">
	<div class="col-md-8 card wide">
		<div class="card-header">	Manage Status </div>
		<div class="card-content">
				<div class="status-wrap">
					<div class="status" >
						<div class="text-normal font-light"> Current Status: </div>
						<div class="boxed-title bg-accent-1 font-bold"><%= IsoRegistrationState.stateLabel(state) %></div>
						<div class="status-paragraph font-light"><%= IsoRegistrationState.stateDefinition(state) %></div>
					</div>
					<% if @registration_state.can_be_changed? %>
					<div class="icon-arrow-r status-arrow"></div>
					<div class="status">
						<div class="text-normal font-light"> New Status: </div>
						<div class="boxed-title bg-sec-light font-bold"><%= IsoRegistrationState.stateLabel(nextState) %></div>
						<div class="status-paragraph font-light"><%= IsoRegistrationState.stateDefinition(nextState) %></div>
					</div>
				</div>
				<br>
				<%= form_for @registration_state, uri:  iso_registration_state_path(@registration_state.id) do |f| %>
				<center>
					<div class="status form-group">
						<div class="text-small font-light">Administrative Note: </div>
							<%= f.text_area :administrativeNote, autofocus: true, class: "form-control", rows:4 %>
					</div>
					<div class="status form-group">
						<div class="text-small font-light">Unresolved Issue: </div>
							<%= f.text_area :unresolvedIssue, class: "form-control", rows:4 %>
					</div>
					<%= f.hidden_field :mi_id, :value => @managed_item.id %>
					<%= f.hidden_field :mi_namespace, :value => @managed_item.namespace %>
					<%= f.hidden_field :previousState, :value => state %>
					<%= f.hidden_field :registrationStatus, :value => nextState %>
					<%= f.hidden_field :referer, :value => @referer %>
					<%= f.submit "Submit Status Change", class: "btn medium", id: 'state_submit' %>
				</center>
				<% end %>
				<br>
				<% else %>
					</div>
					<br>
					<div class="font-light text-centered"><i> The status of this item cannot be changed. </i></div>
				<% end %>
		</div>
	</div>
	<div class="col-md-4 card narrow">
		<div class="card-header">	Version Control	</div>
		<div class="card-content">
			<span class="text-normal font-light"> Make item current: </span>
			<% if @registration_state.released_state? %>
				<% if @managed_item.current? %>
					<%= render partial: "shared/buttons/ico_btn_secondary", :locals => {link_path: "", id: "make_current",
						icon: "icon-new", btn_text: "Item is already current", dt_toggle: "", disabled: true } %>
				<% else %>
					<%= render partial: "shared/buttons/ico_btn_secondary", :locals => {link_path: current_iso_registration_states_path(:new_id => @registration_state.id, :old_id => @current_id), id: "make_current",
						icon: "icon-new", btn_text: "Update to current", dt_toggle: "", disabled: false } %>
				<% end %>
			<% else %>
				<%= render partial: "shared/buttons/ico_btn_secondary", :locals => {link_path: "", id: "make_current",
					icon: "icon-new", btn_text: "Item status is not '".concat(IsoRegistrationState.releasedState, "'") , dt_toggle: "", disabled: true } %>
			<% end %>
			<br><br>

			<div class="text-normal font-light"> Version information: </div>
			<table class="table table-striped table-bordered table-condensed font-light text-small">
				<thead>
					<tr><th>Version</th><th>Version Label</th><th>Internal Version</th></tr>
				</thead>
					<td> <%= @managed_item.semantic_version%> </td>
					<td> <%= @managed_item.versionLabel%> </td>
					<td> <%= @managed_item.version%> </td>
			</table>

			<%= form_for @scoped_identifier, uri: iso_scoped_identifier_path(@scoped_identifier.id) do |f| %>
				<span class="form-group" style="display: inline-block;">
						<div class="text-small font-light">Version Label: </div>
						<%= f.text_field :versionLabel, autofocus: true, class:"form-control font-light" %>
				</span>
				<%= f.submit "Update version label", class: "btn medium", id: 'version_submit' %>
			<% end %>
		</div>
	</div>
</div>
