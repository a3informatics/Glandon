<%= javascript_tag 'setPageTitle("Background jobs")' %>
<%= javascript_pack_tag 'backgrounds/index' %>

<% first_level_breadcrumb (:backgrounds) %>

<div class="row">
	<%= render layout: "shared/headers/header_generic", :locals => {badge: "icon-jobs", header_title: "",
		main_text: "Background Jobs", sub_texts: "List of active and past background jobs." } do %>
	<% end %>
</div>

<div class="row">

	<div class="col-md-12 card wide">

		<div class="card-header">
			Background Jobs
		</div>

		<div class="card-content table-cardstyle" style="overflow: visible;">
			<div class="font-light">
				Note that Background Jobs associated with Imports can only be deleted when their respective Import has been deleted.
			</div>

			<br>

			<table id="main" class="table table-striped table-bordered table-condensed">
				<thead>
			  	<tr>
			    	<th>Description</th>
			    	<th>Status</th>
			    	<th>Started At</th>
			    	<th class="fit">% Complete</th>
			    	<th class="fit">Complete</th>
			    	<th>Completed At</th>
		        <th class="fit"></th>
			  	</tr>
				</thead>
				<tbody>
					<% @jobs.each do |job| %>
			    	<tr>
							<td><%= job.description.presence || "No description." %></td>
			    		<td>
								<%if (job.status.presence || "").length < 120 %>
									<%= job.status %>
								<% else %>
								  <%= job.status[0..120].concat('...') %>
									<span class="icon-view ttip"> <span class="font-light">Hold mouse to see details</span> <span class="ttip-text wrap shadow-small text-medium text-small"><%= job.status %></span></span>
								<% end %>
							</td>
			    		<td><%= Timestamp.new(job.started).to_datetime %></td>
			    		<td class="text-center"><%= job.percentage %></td>
			    		<%= true_false_glyphicon(job.complete) %>
			    		<td><%= Timestamp.new(job.completed).to_datetime %></td>
		          <td>
								<button class="btn icon-only red btn-xs remove-job" data-url="<%= background_path(job) %>" data-method="DELETE">
									<span class="icon-trash"></span>
								</button>
		          </td>
			    	</tr>
					<% end %>
			  </tbody>
			</table>

			<button class="btn red medium remove-job" id="delete-completed-button" data-url="<%= destroy_multiple_backgrounds_path({backgrounds: {items: "completed"}}) %>" data-method="DELETE">
				<span class="icon-trash"></span> Delete Completed
			</button>

			<button class="btn red medium remove-job" id="delete-all-button" data-url="<%= destroy_multiple_backgrounds_path({backgrounds: {items: "all"}}) %>" data-method="DELETE">
				<span class="icon-trash"></span> Delete All
			</button>
		</div>

	</div>

</div>
