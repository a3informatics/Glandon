<%= javascript_tag 'setPageTitle("Ad-Hoc Reports")' %>
<%= javascript_include_tag 'standard_datatable', 'ad_hoc_reports/index' %>
<% if Rails.env == "test" || Rails.env == "development" %>
  <%= javascript_include_tag 'rspec_helper' %>
<% end %>
<% first_level_breadcrumb (:ad_hoc_reports) %>

<%= javascript_tag "var startParamReportUrl = '#{run_start_ad_hoc_report_path(id: "reportId", ad_hoc_report: {query_params: ["reportParam"]})}'" %>

<div class="row">
	<%= render layout: "shared/headers/header_generic", :locals => {badge: "icon-document", header_title: "",
		main_text: "Ad-Hoc Reports", sub_texts: "View, manage and run your Ad-Hoc reports." } do %>
	<% end %>
</div>

<div class="row centered">
	<div class="col-md-10 card wide">
		<div class="card-header">Index: Ad-Hoc Reports</div>
		<div class="card-content table-cardstyle">
			<table id="main" class="table table-striped table-bordered table-condensed">
				<thead>
			  	<tr>
			    	<th>Label</th>
						<th>Required Parameter</th>
			    	<th>Last Run</th>
			    	<th class="fit">Active</th>
			    	<th class="fit"></th>
			  	</tr>
				</thead>
				<tbody>
					<% @items.each do |item| %>
			    	<tr>
							<td><%= item.label %></td>
							<td><%= item.parameters? ? item.parameters.first[:name] : "" %></td>
			    		<td><%= Timestamp.new(item.last_run).to_datetime %></td>
			    		<%= true_false_glyphicon(item.active) %>
							<td class="text-right">
								<%= render layout: "shared/context_menu/con_menu", :locals => {menu_id: "header-con-menu", color: "blue", side: "left"} do %>

					        <%= render partial: "shared/context_menu/con_menu_item", :locals => {link_path: item.parameters? ? "#" : run_start_ad_hoc_report_path(item),
										icon: "icon-history", id: "run-#{item.id}", text: "Run", dt_toggle: "", disabled: false } %>
				          <%= render partial: "shared/context_menu/con_menu_item", :locals => {link_path:  results_ad_hoc_report_path(item), icon: "icon-copy",
				            id: "results-#{item.id}", text: "Results", dt_toggle: "", disabled: false} %>

									<% if policy(AdHocReport).destroy? %>
					          <%= render partial: "shared/context_menu/con_menu_item", :locals => {link_path: "#", id: "delete-#{item.id}",
					            icon: "icon-trash", text: "Delete", dt_toggle: "", disabled: false } %>
										<%= link_to "", ad_hoc_report_path(item), method: :delete, id: "delete_link_#{item.id}" %>
									<% end %>

					      <% end %>
								<% if item.parameters? %>
									<input type="hidden" id="paramtype-<%=item.id%>" value="<%= item.parameters.first[:type].to_s %>"/>
									<input type="hidden" id="paramdescription-<%=item.id%>" value="<%= item.parameters.first[:description] %>"/>
								<% end %>
							</td>
			    	</tr>
					<% end %>
			  </tbody>
			</table>
			<% if policy(AdHocReport).create? %>
				<%= link_to "+ Add New", new_ad_hoc_report_path, :class => "btn medium green" %>
			<% end %>
		</div>
		<%= render partial: "shared/iso_managed/managed_items_select_modal", :locals => {type: :items_generic, select_multiple: false,
			description: "Select one item to run the report based on."} %>
	</div>
</div>
