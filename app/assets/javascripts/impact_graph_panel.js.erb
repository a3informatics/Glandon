/*
* Impact Panel
* 
* Requires:
* d3 [Div] the d3 div
*/

/**
 * Impact Graph Panel Constructor
 *
 * @param clcikBackCall [Function] the callback function.
 * @return [Null]
 */
function ImpactGraphPanel(clickCallBack) {
  var _this = this;
  // Create empty graph
  this.graph = {};
  this.graph.nodes = [];
  this.graph.links = [];
  this.currentNode = null;
  this.currentGRef = null;
  this.clickCallBack = clickCallBack;
  this.nextKey = 1;
  // Init D3
  d3gInit(colours, 25);
  // Set window resize.
  window.addEventListener("resize", this.draw.bind(this));
}

/**
 * Node Click
 *
 * @param node [Object] the node clicked on
 * @return [Null]
 */
ImpactGraphPanel.prototype.nodeClick = function (node) {
  if (this.currentGRef !== null) {
    d3gClearNode(this.currentGRef);
  }
  this.currentGRef = d3gFindGRef(node.key);
  if (this.currentGRef !== null) {
	  this.currentNode = node;
  	d3gMarkNode(this.currentGRef);
  	this.clickCallBack(node);
  }
}

/**
 * Empty Function
 *
 * @return [Null]
 */
ImpactGraphPanel.prototype.empty = function () {
}

/**
 * Add Node to the graph
 *
 * @param sourceNode [Object] the source data beign added
 * @return [Object] the node added to the graph. Source node plus additonal properties.
 */
ImpactGraphPanel.prototype.addNode = function (sourceNode) {
  var uri = sourceNode.uri;    
  var node = sourceNode;
  node.name = "";
  node.key = this.nextKey;
  node.type = sourceNode.rdf_type;
  this.nextKey++;
  this.graph.nodes.push(node);
  var index = this.graph.nodes.length - 1;
  node.index = index;
  return node;
}

/**
 * Link Nodes
 *
 * @param source [Integer] index of the source node
 * @param target [Integer] index of the target node
 * @return [Boolean] always returns true
 */
ImpactGraphPanel.prototype.addLink = function (source, target) {
  var link = {};
  link["source"] = source;
  link["target"] = target;
  this.graph.links.push(link);
  return true;
}

/**
 * Draw the graph
 *
 * @return [Null]
 */
ImpactGraphPanel.prototype.draw = function () {
  var json = JSON.parse(JSON.stringify(this.graph));
  d3gDraw(json, this.nodeClick.bind(this), this.empty.bind(this));
}