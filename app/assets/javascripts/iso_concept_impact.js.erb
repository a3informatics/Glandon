$(document).ready(function() {

  var newIndex;
  
  // Get initial / root item.
  var html = $("#jsonData").html();
  var results = $.parseJSON(html);
  var graph = new ImpactGraphPanel(clickCallBack.bind(this));
  var miTable = new IsoManagedListPanel();
  var ajaxCount = 0;

  // Add graph root.
  results.item.rdf_type = results.item.type; // @todo Need to fix this in the main code.
  var rootNode = graph.addNode(results.item);
	if (results.children.length === 0) {
		graph.draw();
	} else {
		spAddSpinner("#processing");
  	processChildren(results.children, rootNode.index, 1);
	}

	$('#close').click(function() {
    history.back();
  });

  function processChildren(children, index, level) {
		var node;
	  for (var i=0; i<children.length; i++) {
	  	children[i].level = level;
	    node = graph.addNode(children[i]); // Add node to graph
	    graph.addLink(index, node.index); // Add links to graph
	    miTable.add(children[i].uri, node.key); // Add to table
	    if (level <= maxImpactHops) {
	    	processChild(children[i], node.index, (level + 1));
	    }
	  }
	  graph.draw();
	}

	function processChild(child, index, level) {
		ajaxCount++;
	  $.ajax({
	    url: "/iso_managed/impact",
	    data: { "id": getId(child.uri), "namespace": getNamespace(child.uri) },
	    type: 'GET',
	    dataType: 'json',
	    success: function(result) {
	      processChildren(result.children, index, level);
				ajaxCount--;
	      if (ajaxCount === 0) {
	      	spRemoveSpinner("#processing");
	      }
	    },
	    error: function(xhr,status,error){
	    	spRemoveSpinner("#processing");
	      handleAjaxError(xhr, status, error);
	    }
	  });
	}

	function clickCallBack(node) {
		miTable.highlight(node.key);
	}

});

