/*
* Managed Item Selector Panel
*/

/*
* Params
** type [String] type of the panel (thesauri/cls/clitems)
** errorDiv [JQUery Object] Div for showing errors
** multiple [Boolean] enable/disable multiple item selection
** callback [Function] Called on selection change, data passed into parameters
** columns [Function] Columns definitions function
** urls [Object] index and history URLs
*/

/**
* Managed Item Selector PanelConstructor
*
* @param [Object] user-defined values
* @return [void]
*/
function MISelector(params) {
 this.params = params;
 this.div = $("#selector-" + params.type);
 this.callback = params.callback;
 this.initialized = false;
 this.cache = {};

 this.indexTable = this.indexTableInit();
 this.historyTable = this.historyTableInit();
 this.setListeners();
}

/**
 ****** General ******
**/

/**
 * Show panel event
 *
 * @return [void]
 */
MISelector.prototype.show = function(){
  if (!this.initialized)
    this.loadData({
      url: this.params.urls.index,
      target: this.indexTable,
      offset: 0,
      count: this.getItemCount(this.indexTable),
      cacheData: false
    });
}

/**
 * Sets listeners
 *
 * @return [void]
 */
MISelector.prototype.setListeners = function() {
  this.indexTable.on('select.dt deselect.dt', this.onIndexSelect.bind(this));

  this.historyTable.on('select.dt deselect.dt', this.onHistorySelect.bind(this));
}

/**
 * Loads data into tables
 *
 * @return [void]
 */
MISelector.prototype.loadData = function (params) {
  if(params.offset == 0)
    this.processing(true);

	$.ajax({
		url: params.url,
		type: 'GET',
		dataType: 'json',
    data: this.loadDataParams(params.count, params.offset),
		context: this,
		success: function (result) {
			$.each(result.data, function(index, item) {
				params.target.row.add(item);
			});
      params.target.draw();

			if (result.count != null && result.count >= params.count)
        this.onTablePageLoaded(params);
			else
        this.onTableLoaded(params);
		},
		error: function (xhr, status, error) {
      handleAjaxError(xhr, status, error, this.params.errorDiv);
			this.processing(false);
		}
	});
}

/**
 * Loads history data from server or cache
 *
 * @param data [Object] data of item selected in the index table
 * @return [void]
 */
MISelector.prototype.loadHistory = function (data) {
  var key = data.identifier + data.scope_id;

  if (!this.loadFromCache(key, this.historyTable))
    this.loadData({
      url: this.makeHistoryUrl(data.identifier, data.scope_id),
      target: this.historyTable,
      offset: 0,
      count: this.getItemCount(this.historyTable),
      cacheData: true,
      cacheKey: data.identifier + data.scope_id
    });
}

/**
 ****** Cache ******
**/

/**
 * Load from cachce
 *
 * @param key [String] Key under which to find cached data
 * @param table [DataTable] Table which to load data into
 * @return [void]
 */
MISelector.prototype.loadFromCache = function (key, table) {
  var cacheData = this.cache[key];

  if(cacheData != null) {
    $.each(cacheData, function(index, row){ table.row.add(row); });
    table.draw();
    return true;
  }
  else
    return false;
}

/**
 * Saves data to cache
 *
 * @param key [String] Key under which to save table data
 * @param table [DataTable] Table whose data to save
 * @return [void]
 */
MISelector.prototype.saveToCache = function (key, table) {
  if (this.cache[key] == null)
    this.cache[key] = table.rows().data();
}

/**
 * Clears cache
 *
 * @return [void]
 */
MISelector.prototype.clearCache = function () {
  delete this.cache;
  this.cache = {};
}

/**
 ****** Events ******
**/

/**
 * Called when each chunk (page) of data is loaded
 *
 * @return [Object] request params
 */
MISelector.prototype.onTablePageLoaded = function (params) {
  this.processing(false);
  toggleTableActive("#index", false);
  params.offset += params.count;
  this.loadData(params);
}

/**
 * Called when each data is finished loading
 *
 * @return [Object] request params
 */
MISelector.prototype.onTableLoaded = function (params) {
  if (params.cacheData)
    this.saveToCache(params.cacheKey, params.target);

  this.processing(false);
  this.initialized = true;
}

/**
 * Generates history url
 *
 * @return [String] history url
 */
MISelector.prototype.onIndexSelect = function (e, dt, type, indexes) {
  switch (e.type) {
    case "select":
      var data = this.indexTable.row(indexes[0]).data();
      this.loadHistory(data);
      break;
    case "deselect":
      this.clearTable(this.historyTable);
      break;
  }
}

/**
 * Generates history url
 *
 * @return [String] history url
 */
MISelector.prototype.onHistorySelect = function (e, dt, type, indexes) {
  var data = this.historyTable.rows(indexes).data();
  var selected = e.type == "select";
  this.params.callback(this.params.type, selected, data);
}

/**
 ****** Support ******
**/

/**
 * Generates history url
 *
 * @param identifier [String] Item identifier
 * @param scopeId [String] Scope Id
 * @return [String] history url
 */
MISelector.prototype.makeHistoryUrl = function (identifier, scopeId) {
  return this.params.urls.history.replace("miHistoryId", identifier).replace("miScopeId", scopeId);
}

/**
 * Generates parameters for request for fetching data
 *
 * @return [Int] Item count for specific type
 */
MISelector.prototype.getItemCount = function(target){
	if (target == this.indexTable)
    return 1000;
  else
    return 100;
}

/**
 * Generates parameters for request for fetching data
 *
 * @param [Int] Data Count
 * @param [Int] Data Offset
 * @return [Object] ajax load data parameters
 */
MISelector.prototype.loadDataParams = function(c, o){
  switch (this.params.type) {
    case "cls":
      return { managed_concept: { count: c, offset: o, type: "all" } };
    case "thesauri":
      return { thesauri: { count: c, offset: o } };
  }
}

/**
 * Enables or disables processing within the modal tables
 *
 * @param enable [Boolean] Processing enable / disable == true / false
 * @return [void]
 */
MISelector.prototype.processing = function (enable) {
  this.indexTable.processing(enable);
  this.historyTable.processing(enable);
  toggleTableActive("#index", !enable);
  toggleTableActive("#history", !enable);
}

/**
 * Clears both tables' data
 *
 * @return [void]
 */
MISelector.prototype.clearTable = function (target) {
  target.rows().remove().draw();
}

/**
 ****** Initializers ******
**/

/**
 * Initialize the Index table
 *
 * @return [void]
 */
MISelector.prototype.indexTableInit = function() {
  return $(this.div).find("#index").DataTable({
    "order": [[0, "desc"]],
		"columns": this.params.columns("index"),
		"pageLength": 10,
    "lengthChange": false,
		"processing": true,
		"paging": true,
    "scrollY": 400,
    "scrollCollapse": true,
    "select": "single",
    "autoWidth": false,
		"language": {
			"infoFiltered": "",
			"emptyTable": "No items were found.",
			"processing": generateSpinner("small")
		},
    "createdRow": function(row, data, dataIndex) {
     $(row).addClass(data.owner.toLowerCase() == "cdisc" ? 'row-cdisc y' : 'row-sponsor b');
   }
  });
}

/**
 * Initializes index table
 *
 * @return [void]
 */
MISelector.prototype.historyTableInit = function () {
  return $(this.div).find("#history").DataTable({
    "order": [[0, "desc"]],
		"columns": this.params.columns("history"),
		"pageLength": 10,
    "lengthChange": false,
		"processing": true,
    "scrollY": 400,
    "scrollCollapse": true,
    "select": (this.params.multiple == true ? "multi" : "single"),
		"paging": true,
    "autoWidth": false,
		"language": {
			"infoFiltered": "",
			"emptyTable": "No items were found.",
			"processing": generateSpinner("small")
		}
  });
}
