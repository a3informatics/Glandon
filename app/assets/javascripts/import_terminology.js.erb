var itUri = "";
var itFilename = "";

// Import Terminology view
$(document).ready( function() {
  var itp = new ImportTermPanel();
});

// Import Term Panel
function ImportTermPanel() {
  this.iclp = new ImportCodeListPanel(this.status);

  var _this = this;
  
  $('#list_button').click(function() {
    var uri = $('#thesaurus').val();
    var filename = $('#filename').val();
    if (uri === "" || filename === null) {
      displayError("You need to seelct a terminology and a file.");
    } else {
      _this.iclp.refresh(uri, filename);
    }
  });
 
}

ImportTermPanel.prototype.status = function(operating) {
  $('#list_button').prop('disabled', operating);
}

// Import Code List Panel
function ImportCodeListPanel(callback) {
  var _this = this;
  this.callback = callback;
  this.uri = "";
  this.filename = "";
  this.error_count = 0;
  $('#import_spinner').prop('disabled', true);
  $('#error_table_div').hide();
  this.listTable = $('#list_table').DataTable( {
    "columns": [
      {"data" : "identifier"},
      {"data" : "label"}
    ],
    ajax: {
      url: "/imports/terms",
      data: function (d) {
        d.imports = {};
        d.imports.filename = itFilename;
        d.imports.uri = itUri;
      },
      error: function (xhr, status, error) {
        var html = alertError("An error has occurred loading the Code List table.");
        displayAlerts(html);
      }
    },
    select: { style: 'multi' },
    "pageLength": pageLength, // Gloabl setting
    "lengthMenu": pageSettings, // Gloabl setting
    "processing": true,
    "language": {
      "processing": "<img src='<%= asset_path('processing.gif') %>'>"
    }
  });
  this.errorTable = $('#error_table').DataTable( {
    "columns": [
      {"data" : "index"},
      {"data" : "error"}
    ],
    "pageLength": pageLength, // Global setting
    "lengthMenu": pageSettings, // Global setting
  });

  $('#import_button').click(function() {
    identifiers = [];
    data = _this.listTable.rows({selected: true}).data();
    for (i=0; i<data.length; i++) {
      identifiers.push(data[i].identifier);
    }
    _this.listTable.rows({ selected: true }).deselect();
    _this.status(true);
    _this.import(identifiers);
  });

}
 
ImportCodeListPanel.prototype.refresh = function(uri, filename) {
  itUri = uri;
  itFilename = filename;
  this.listTable.clear().draw();
  this.listTable.ajax.reload();
  this.errorTable.clear().draw();
  this.error_count = 0;
  $('#error_table_div').hide();
}

ImportCodeListPanel.prototype.import = function(identifiers) {
  var _this = this;
  identifier = identifiers.pop();
  $.ajax({
    url: "/imports/terms",
    data: { imports: { "filename": itFilename, "uri": itUri, "identifier": identifier} },
    type: 'POST',
    dataType: 'json',
    success: function(result) {
      for (var i=0; i<result.errors.length; i++) {
        _this.error_count += 1;
        _this.errorTable.row.add({ "index": _this.error_count, "error": result.errors[i]});
      }
      _this.errorTable.draw();
      if (identifiers.length > 0) {
        _this.import(identifiers);
      } else {
        _this.status(false);
      }
    },
    error: function(xhr,status,error){
      _this.status(false);
      handleAjaxError(xhr, status, error);
    }
  });
}

ImportCodeListPanel.prototype.status = function(operating) {
  this.callback(operating);
  $('#import_button').prop('disabled', operating);
  if (operating) {
    spAddSpinner("#import_spinner");
    this.listTable.select.style('api'); // Disables selection
    this.errorTable.clear().draw();
    this.error_count = 0;
    $('#error_table_div').hide();
  } else {
    spRemoveSpinner("#import_spinner");
    this.listTable.select.style('multi');
    if (this.error_count > 0) {
      $('#error_table_div').show();
    }
  }
}
