var formDefinition ;
var rootNode;
var bcCurrent;
var bcCurrentRow;
var notepadTableReload;
var norepadTable;
var notepadData;
var notepadRow;
var varClCurrent;
var varClCurrentRow;
var questionDatatypeValue
var markdownElement;
var markdownType;
var previousSave;
var bcSelect;
var idKeyMap;

$(document).ready(function() {

  $("#saving").prop("disabled", true);
  
  // Set up the form validation
  validatorDefaults ();
  $('#main_form').validate({
    rules: {
        "Form Identifier": {required: true, identifier: true },
        "Form Label": {required: true, label: true },
        "Form Note": {required: false, markdown: true},
        "Form Completion": {required: false, markdown: true},
        "Group Label": {required: true, label: true },
        "Group Note": {required: false, markdown: true},
        "Group Completion": {required: false, markdown: true},
        "Question Label": {required: true, label: true },
        "Question Text": {required: true, question: true },
        "Question Note": {required: false, markdown: true},
        "Question Completion": {required: false, markdown: true},
        "Placeholder Text": {required: false, markdown: true},
        "Label Text Label": {required: true, label: true},
        "Label Text Text": {required: false, markdown: true},
        "Code List Label": {required: true, label: true },
        "Common Label": {required: true, label: true }
    },
    submitHandler: function(form) {
      saveRest();
      return false;
    },
    invalidHandler: function(event, validator) {
      displayWarning("The form is not valid. Please correct the errors.");
    }
  });

  questionClTable = $('#questionClTable').DataTable({
    "searching": false,
    "pageLength": 5,
    "lengthChange": false,
    "columns": [
      {"data" : "identifier", "width" : "50%"},
      {"data" : "useful_1", "width" : "50%"},
    ]
  });
  questionClTable.clear();

  bcSelect = $('#bcTable').DataTable( {
    "ajax": {
      "url": "/biomedical_concepts/list",
      "dataSrc": "data",
      error: function (xhr, status, error) {
        displayError("An error has occurred loading the Biomedical Concepts table.");
      }
    },
    dataType: 'json',
    "pageLength": 5,
    "lengthMenu": [[5, 10, 25, 50], [5, 10, 25, 50]],
    "pagingType": "full",
    "bProcessing": true,
    "language": {
      "infoFiltered": "",
      "processing": "<img src='<%= asset_path('processing.gif') %>'>"
    },
    "columns": [
      {"data" : "identifier", "width" : "50%"},
      {"data" : "label", "width" : "50%"}
    ]
  });

  function initialNotepadLoad () {
    notepadTable = $('#notepad_table').DataTable( {
      "ajax": {
        "url": "/notepads/index_term",
        "dataSrc": "data"  
      },
      "bProcessing": true,
      "bInfo" : false,
      "searching": false,
      "pageLength": 5,
      "lengthMenu": [[5, 10, 15, 20, 25], [5, 10, 15, 20, 25]],
      "language": {
             "processing": "<img src='<%= asset_path('processing.gif') %>'>"
        },
      "columns": [
        {"data" : "identifier", "width" : "30%"},
        {"data" : "useful_1", "width" : "70%"}
      ]
    });
    notepadTableReload = true;    
  }

  $('#notepad_refresh').click(function() {
    if (!notepadTableReload) {
      initialNotepadLoad();
    } else {
      notepadTable.ajax.reload();
    }
  });

  $('#notepad_add').click(function() {
    var data;
    var text;
    if (notepadRow != null) {
      data = notepadTable.row(notepadRow).data();
      questionClTable.row.add(data);
      questionClTable.draw(false);
    }
  });

  $('#notepad_table tbody').on('click', 'tr', function () {
    var row = notepadTable.row(this).index();
    var data = notepadTable.row(row).data();
    if (notepadRow != null) {
      $(notepadRow).toggleClass('success');
    }
    $(this).toggleClass('success')
    notepadData = data;
    notepadRow = this
  });

  // Initialise everything.
  initData();
  initialNotepadLoad();
  displayNode(rootNode);

  /*
  * General Panel Actions
  */
  $('#close').click(function() {
    saveNode();
    saveRest();
    keepToken = true;
    window.location.href = $('#close_path').val();
  });

  // Function for testing. Allows a tree node to be clicked.
  $('#click_node').click(function() {
    var nodeName = $('#click_node_text').val();
    var node = d3FindGRefByName(nodeName);
    simulateClick(node);
  });

  $('#test').click(function() {
    var ordinal = getOrdinal($('#click_node_text').val());
    $('#test_text').val(ordinal)
  });

  /*
  * Button class actions
  */
  $('.node-up-action').click(function() {
    treeNodeUp();
  }); 

  $('.node-down-action').click(function() {
    treeNodeDown();
  });

  $('.node-delete-action').click(function() {
    treeNodeDelete();
  });

  /*
  * Form Panel Actions
  */
  $('#formAddGroup').click(function() {
    var currentNode = d3eGetCurrent()
    if (currentNode === null) {
      displayWarning("You need to select the form node.");
    } else {
      saveForm(currentNode);
      var node = addGroup(currentNode);
      displayNode(node);
    }
  });

  /*
  * Group Panel Actions
  */
  $('#groupAddGroup').click(function() {
    treeNodeAdd(addGroup);
  });

  $('#groupDelete').click(function() {
    treeNodeDelete();
  });

  $('#groupAddCommon').click(function() {
    var currentNode = d3eGetCurrent()
    if (currentNode === null) {
      displayWarning("You need to select a group node.");
    } else if (hasCommonGroup(d3eGetCurrent())) {
      displayWarning("Group already has a common node.");
    } else {
      var node = addCommonGroup(d3eGetCurrent());
      displayNode(node);
    }
  }); 

  $('#groupAddBc').click(function() {
    var currentNode = d3eGetCurrent()
    if (currentNode === null) {
      displayWarning("You need to select a group node.");
    } else if (bcCurrent === null) {
      displayWarning("You need to select a Biomedical Concept.");
    } else {
      addBc(currentNode);
    }
  }); 

  $('#groupAddQuestion').click(function() {
    treeNodeAdd(addQuestion);
  }); 

  $('#groupAddMapping').click(function() {
    treeNodeAdd(addMapping);
  }); 

  $('#groupAddPlaceholder').click(function() {
    treeNodeAdd(addPlaceholder);
  }); 

  $('#groupAddLabelText').click(function() {
    treeNodeAdd(addLabelText);
  }); 

  /*
  * BC Panel Actions
  */
  $('#bcDelete').click(function() {
    treeNodeDelete();
  });

  /*
  * Item Panel Actions
  */
  $('#itemCommon').click(function() {
    var currentNode = d3eGetCurrent()
    if (currentNode === null) {
      displayWarning("You need to select an item node.");
    } else {
      var node = makeCommon(currentNode);
      displayNode(node);
    }
  }); 

  $('#itemRestore').click(function() {
    var currentNode = d3eGetCurrent()
    if (currentNode === null) {
      displayWarning("You need to select an item node.");
    } else {
      restoreCommon(currentNode);
      treeNodeDelete();
    }
  }); 

  /*
  * Code List Panel Actions
  */
  $('#clDefault').click(function() {
    if (d3eGetCurrent() == null) {
      displayWarning("You need to select a code list node.");
    } else {
      clLabelElement.value = d3eGetCurrent().data.subject_data.label;
    }
  });
  
  $('#clUp').click(function() {
    treeNodeUp();
  }); 

  $('#clDown').click(function() {
    treeNodeDown();
  }); 

  /*
   * Function to handle click on the BC selection table.
   */
  $('#bcTable tbody').on('click', 'tr', function () {
    handleBCTable(bcSelect, this);
  });

  /*
   * Function to handle click on question cl table
   */
  $('#questionClTable tbody').on('click', 'tr', function () {
    handleQuestionTable(questionClTable, this);
  });

  /* 
  * Function to handle the terminology button clicks.
  */
  $('#deleteTerm').click(function() {
    var data;
    if (varClCurrentRow == null) {
      displayWarning("You need to select a code list item.");
    } else {
      questionClTable.row(varClCurrentRow).remove();
      varClCurrentRow = null;
      questionClTable.draw();
    }
  });

  $('#questionDatatype input:radio').click(function() {
    var value = $(this).val();
    clEnableDisable(value);
    clFormat(value);
    questionDatatypeValue = value;
  });

  /*
  * Functions to handle completion instructions
  */
  $('#markdown_preview').click(function() {
    if (markdownElement == null) {
      displayWarning("You need to select a completion instruction field.");
    } else {
      var text = markdownElement.value;
      getMarkdown(document.getElementById("genericCompletion"), text, markdownCallback);  
    }
  });

  $('#markdown_hide').click(function() {
    hideCi();
    if (markdownType == C_NORMAL_GROUP) {
      showBCSelection();
    } else if (markdownType == C_QUESTION) {
      showNotepad();    
    }
    markdownElement = null;
    markdownType = "";
  });

  $( "#formCompletion" ).focus(function() {
    handleFocus(C_FORM, document.getElementById("formCompletion"));
  });

  $( "#formNote" ).focus(function() {
    handleFocus(C_FORM,  document.getElementById("formNote"));
  });

  $( "#groupCompletion" ).focus(function() {
    hideBCSelection();
    handleFocus(C_NORMAL_GROUP, document.getElementById("groupCompletion"));
  });

  $( "#groupNote" ).focus(function() {
    hideBCSelection();
    handleFocus(C_NORMAL_GROUP, document.getElementById("groupNote"));
  });

  $( "#questionCompletion" ).focus(function() {
    hideNotepad();
    handleFocus(C_QUESTION, document.getElementById("questionCompletion"));
  });

  $( "#questionNote" ).focus(function() {
    hideNotepad();
    handleFocus(C_QUESTION, document.getElementById("questionNote"));
  });

  $( "#placeholderText" ).focus(function() {
    handleFocus(C_PLACEHOLDER, document.getElementById("placeholderText"));
  });

  $( "#labelTextText" ).focus(function() {
    handleFocus(C_TEXTLABEL, document.getElementById("labelTextText"));
  });

});

/*
* Utilty Functions
* ================
*/

function handleFocus(type, element) {
  showCi();
  markdownType = type;
  markdownElement = element;
  getMarkdown(element, element.value, markdownCallback);
}

function markdownCallback(element, text) {
  element.innerHTML = text;
}

/*
*
*/
function clEnableDisable (value) {
  if (value == "I" || value == "S" || value == "F") {
    $("#questionFormat").prop('disabled', false);
    $("#notepad_add").prop('disabled', true);
    $("#deleteTerm").prop('disabled', true);
  } else {
    $("#questionFormat").prop('disabled', true);
    $("#notepad_add").prop('disabled', false);
    $("#deleteTerm").prop('disabled', false);
  }
}

function clFormat (value) {
  if (value == "I") {
    questionFormatElement.value = "3"
  } else if (value == "S") {
    questionFormatElement.value = "20"
  } else if (value == "F") {
    questionFormatElement.value = "6.2"
  } else {
    questionFormatElement.value = ""
  }
}

function selectForm() {
  clearSelect();
  $("#formInfo").removeClass('hidden');
}

function selectGroup() {
  clearSelect();
  $("#groupInfo").removeClass('hidden');
  $("#bcSelection").removeClass('hidden');
}

function selectBC() {
  clearSelect();
  $("#bcInfo").removeClass('hidden');
}

function showBCSelection() {
  $("#bcSelection").removeClass('hidden');
}

function hideBCSelection() {
  $("#bcSelection").addClass('hidden');
}

function selectCommon() {
  clearSelect();
  $("#commonInfo").removeClass('hidden');
}

function selectItem() {
  clearSelect();
  $("#itemInfo").removeClass('hidden');
}

function selectQuestion() {
  clearSelect();
  $("#questionInfo").removeClass('hidden');
  $("#notepad_panel").removeClass('hidden');
}

function selectMapping() {
  clearSelect();
  $("#mappingInfo").removeClass('hidden');
}

function selectPlaceholder() {
  clearSelect();
  $("#placeholderInfo").removeClass('hidden');
  $("#markdown_panel").removeClass('hidden');
}

function selectLabelText() {
  clearSelect();
  $("#labelTextInfo").removeClass('hidden');
  $("#markdown_panel").removeClass('hidden');
}

function selectCl() {
  clearSelect();
  $("#clInfo").removeClass('hidden');
}

function showNotepad() {
  $("#notepad_panel").removeClass('hidden');
}

function hideNotepad() {
  $("#notepad_panel").addClass('hidden');
}

function showCi() {
  $("#markdown_panel").removeClass('hidden');
}

function hideCi() {
  $("#markdown_panel").addClass('hidden');
}

function clearSelect() {
  $('.panel').addClass('hidden');
  $("#general_panel").removeClass('hidden');
}

function removeSpinner() {
  $("#saving > span").removeClass('glyphicon-spin');
}

function addSpinner() {
  $("#saving > span").addClass('glyphicon-spin');
}

// Function for page unload. Nothing to do
function pageUnloadAction() {
  saveNode();
  saveRest();
}

function saveRest() {
  var uri;
  var method;
  var data;
  var action;
  var form;
  var currentSave = JSON.stringify(formDefinition);
  if (currentSave !== previousSave) {
    addSpinner();
    form = formDefinition.managed_item;
    data = { "namespace": form['namespace'], "form": formDefinition };  
    $.ajax({
      url: "/forms/" + form['id'],
      type: 'PUT',
      data: JSON.stringify(data),
      dataType: 'json',
      contentType: 'application/json',
      success: function(result){
        removeSpinner();
      },
      error: function(xhr, status, error){
        handleAjaxError (xhr, status, error);
        removeSpinner();
      }
    });
    previousSave = currentSave;
  } 
}

/*
* Generic functions
*/
function treeNodeAdd(addFunction) {
  var currentNode = d3eGetCurrent();
  if (currentNode === null) {
    displayWarning("You need to select a node.");
  } else {
    saveNode();
    var node = addFunction(currentNode);
    displayNode(node);
  }
}

function treeNodeDelete(checkChildren = false) {
  var currentNode = d3eGetCurrent();
  if (currentNode === null) {
    displayWarning("You need to select a node.");
  } else {
    if (checkChildren && hasChildren(currentNode)) {
      displayWarning("You need to remove the child nodes.");
    } else {
      var node = d3eDeleteNode(currentNode);
      displayNode(node);
    } 
  }
}

function treeNodeUp() {
  var currentNode = d3eGetCurrent();
  if (currentNode === null) {
    displayWarning("You need to select a node.");
  } else {
    var parentNode = currentNode.parent;
    if (currentNode.index != 0) {
      d3eMoveNodeUp(currentNode);
      displayNode(currentNode);
    } else {
      displayWarning("You cannot move the node up.");
    }
  }
}

function treeNodeDown() {
  var currentNode = d3eGetCurrent();
  if (currentNode === null) {
    displayWarning("You need to select a node.");
  } else {
    var parentNode = currentNode.parent;
    if (currentNode.index < parentNode.save.length) {
      d3eMoveNodeDown(currentNode);
      displayNode(currentNode);
    } else {
      displayWarning("You cannot move the node down.");
    }
  }
}

/*
 * Functions to display the various panels. 
 */
function displayForm(node) {
  $('#formLabel').val(node.data.label);
  $('#formCompletion').val(node.data.completion);
  $('#formNote').val(node.data.note);
  $("#formIdentifier").prop( "disabled", true );
}

function displayGroup(node) {
  $('#groupLabel').val(node.data.label);
  $('#groupCompletion').val(node.data.completion);
  $('#groupNote').val(node.data.note);
  $( "#groupRepeating").prop('checked', node.data.repeating);
  $( "#groupOptional").prop('checked', node.data.optional);
}

function displayBC(node) {
  $('#bcIdentifier').html(node.data.label);
  $('#bcLabel').html(node.data.label);
}

function displayCommon(node) {
  $('#commonLabel').val(node.data.label);
}

function displayItem(node) {
  $('#itemLabel').html(node.data.label);
  if (isCommonGroup(node.parent)) {
    $("#itemEnable").prop('disabled', true);
    $("#itemOptional").prop('disabled', true);
    $("#itemUpdate").prop('disabled', true);
    $("#itemCommon").prop('disabled', true);
    $("#itemRestore").prop('disabled', false);
  } else {
    $("#itemEnable").prop('disabled', false);
    $("#itemOptional").prop('disabled', false);
    $("#itemUpdate").prop('disabled', false);
    $("#itemCommon").prop('disabled', false);
    $("#itemRestore").prop('disabled', true);
    $("#itemEnable").prop('checked', node.data.enabled);
    $("#itemOptional").prop('checked', node.data.optional);
  }
}

function displayQuestion(node) {
  $('#questionLabel').val(node.data.label);
  $('#questionText').val(node.data.question_text);
  $("#questionOptional").prop('checked', node.data.optional);
  $('#questionMapping').val(node.data.mapping);
  var $radios = $('input:radio[name=dtRadio]');
  $radios.filter('[value=' + node.data.datatype +']').prop('checked', true);
  $('#questionFormat').val(node.data.format);
  $('#questionComplation').val(node.data.completion);
  $('#questionNote').val(node.data.note);
  questionClTable.clear();
  if (node.hasOwnProperty('children')) {
    for (j=0; j<node.children.length; j++) {
      var child = node.children[j];
      var data = child.data
      var ref = data.subject_data;
      var clRow = {identifier: ref.identifier, uri_id: ref.id, uri_ns: ref.namespace, useful_1: ref.notation, useful_2: ref.label}; 
      questionClTable.row.add(clRow);
    }
  }
  clEnableDisable(node.data.datatype);
}

function displayMapping(node) {
  $('#mappingMapping').val(node.data.mapping);
}

function displayPlaceholder(node) {
  $('#plText').val(node.data.free_text);
}

function displayLabelText(node) {
  $('#labelTextLabel').val(node.data.label);
  $('#labelTextText').val(node.data.label_text);
}

function displayCl(node) {
  var clEnableElement = document.getElementById("clEnable");
  var clOptionalElement = document.getElementById("clOptional");
  $('#clIdentifier').html(node.data.subject_data.identifier);
  $('#clLabel').val(node.data.local_label);
  $('#clDefaultLabel').html(node.data.subject_data.label);
  $('#clNotation').html(node.data.subject_data.notation);
  $("#clEnable").prop('checked', node.data.enabled);
  $("#clOptional").prop('checked', node.data.optional);
  parentNode = node.parent;
  if (parentNode.type == C_QUESTION) {
    $("#clLocalLabel").prop('disabled', false);
    $("#clEnable").prop('disabled', true);
  } else {
    $("#clLocalLabel").prop('disabled', true);
    $("#clEnable").prop('disabled', false);
  }
}

/**
 * Functions to save info.
 */
function saveForm(node) {
  node.data.label = $('#formLabel').val();
  node.data.completion = $('#formCompletion').val();
  node.data.note = $('#formNote').val();
  node.name = node.data.label;
}

function saveGroup(node) {
  node.data.label = $('#groupLabel').val();
  node.data.completion = $('#groupCompletion').val();
  node.data.note = $('#groupNote').val();
  node.name = node.data.label;
  node.data.repeating = $('#groupRepeating').is(":checked");
  node.data.optional = $('#groupOptional').is(":checked");
}

function saveCommon(node) {
  node.data.label = $('#commonLabel').val();
  node.name = node.data.label;
}

function saveItem(node) {
  node.data.enabled = $('#itemEnable').is(":checked");
  node.data.optional = $('#clOptional').is(":checked");
  node.enabled = itemEnableElement.checked;
}

function saveQuestion(node) {
  var rowData;
  var i;
  var row;
  var tcRefSNode;
  var tcRefD3Node;
  node.data.label = $('#questionLabel').val();
  node.name = node.data.label;
  node.data.question_text = $('#questionText').val();
  node.data.optional = $('#questionOptional').is(":checked");
  node.data.mapping = $('#questionMapping').val();
  node.data.datatype = $('input:radio[name=dtRadio]:checked').val();
  node.data.format = $('#questionFormat').val();
  node.data.completion = $('#questionCompletion').val();
  node.data.note = $('#questionNote').val();
  node.data.children = [];
  node.save = [];
  node.children = [];
  rowData = questionClTable.rows().data();
  for (i=0; i<rowData.length; i++) {
    row = rowData.row(i).data();
    tcRefSNode = newQuestionCli(row);
    tcRefD3Node = d3eAddNode(node, row.useful_2, C_Q_CL, true, tcRefSNode, true); 
    addSNode(node.data, tcRefSNode, true);
    tcReference(tcRefD3Node);
  }
}

function saveMapping(node) {
  node.data.mapping = $('#mappingMapping').val();
}

function savePlaceholder(node) {
  node.data.free_text = $('#placeholderText').val();
}

function saveLabelText(node) {
  node.data.label = $('#labelTextLabel').val();
  node.data.label_text = $('#labelTextText').val();
  node.name = node.data.label;
}

function saveCl(node) {
  node.data.enabled = $('#clEnable').is(":checked");
  node.data.optional = $('#clOptional').is(":checked");
  node.data.local_label = $('#clLabel').val();
  node.name = node.data.local_label;
  node.enabled = node.data.enabled
}

function makeCommon(node) {
  var returnD3Node = node;
  var commonGroup;
  var commonD3Nodes = [];
  var bcD3Node = node.parent;
  var groupD3Node = bcD3Node.parent;
  if (bcD3Node != null && groupD3Node != null) {
    for (var i=0; i<groupD3Node.save.length; i++) {
      var child = groupD3Node.save[i];
      if (child.type == C_COMMON_GROUP) {
        commonGroup = child;
      } else {
        for (var j=0; j<child.save.length; j++) {
          var item = child.save[j];
          if ('bridg_path' in item.data.property_ref.subject_data) {
            if (node.key == item.key) {
              commonD3Nodes.push(item);
            } else if (node.data.property_ref.subject_data.bridg_path === item.data.property_ref.subject_data.bridg_path) {
              commonD3Nodes.push(item);
            }
          }
        }
      }
    }
    if (commonGroup != null) {
      if (commonD3Nodes.length > 0) {
        var d3CommonItem = addCommonItem(commonGroup, commonD3Nodes[0].name);
        returnD3Node = d3CommonItem;
        for (var k=0; k<commonD3Nodes.length; k++) {
          var d3Node = commonD3Nodes[k];
          refFromCommon(d3CommonItem, d3Node);
        } 
      } else {
        displayWarning("No common items matched.");
      }
    } else {
      displayWarning("A common group was not found.");
    }
  } else {
    if (bcD3Node == null && groupD3Node == null) {
      displayWarning("Cannot find Biomedical Concept and the Group parent nodes.");
    } else if (bcD3Node == null) {
      displayWarning("Cannot find Biomedical Concept parent node.");
    } else if (groupD3Node == null) {
      displayWarning("Cannot find Group parent node.");
    }
  }
  return returnD3Node;
}

// Detaches the node from its 'natural' position
function refFromCommon(d3Parent, d3Node) {
  var ref = {};
  ref.id = d3Node.data.property_ref.subject_ref.id;
  ref.namespace = d3Node.data.property_ref.subject_ref.namespace;
  d3Parent.data.item_refs.push(ref);
  idKeyMap[ref.id] = d3Node.key;
  d3Parent.bridg_path = d3Node.data.property_ref.subject_data.bridg_path;
  setParent(d3Parent);
  setOrdinal(d3Parent.data);
  commonMark(d3Node, true);
  if (!hasChildren(d3Parent)) {
    for (var i=0; i<d3Node.data.children.length; i++) {
      setD3(d3Node.data.children[i], d3Parent);
    }
  }
}

// Restore from common to 'natural' position.
function restoreCommon(d3Node) {
  for (i=0; i<d3Node.data.item_refs.length; i++) {
    var ref = d3Node.data.item_refs[i];
    var key = findKeyFromId(ref.id);
    if (key !== null) {
      var gRef = d3FindGRef(key);
      var commonD3Node = d3GetData(gRef);
      commonMark(commonD3Node, false);
    } else {
      displayError("Cannot restore common item to the owning Biomedical Concept.");
    }
  }
}

function commonMark(d3Node, value) {
  d3Node.is_common = value;
  d3Node.data.is_common = value;
  if (hasChildren(d3Node)) {
    for (var i=0; i<d3Node.children.length; i++) {
      d3Node.children[i].is_common = value;
      //d3Node.data.children[i].is_common = value;
    }
  }
}

function findKeyFromId(id) {
  if (idKeyMap.hasOwnProperty(id)) {
    return idKeyMap[id];
  } else {
    return null;
  }
}

/*
* Group generic functions
*/
function newFormGroup(nullVar) {
  return { 
    type: C_NORMAL_GROUP, label: "", id: "", namespace: "", ordinal: 0, optional: false, repeating: false, 
    note: "", completion: "", bc_ref: {}, children: [] };
}

function newCommonGroup(nullVar) {
  return {
    type: C_COMMON_GROUP, label: "", id: "", namespace: "", ordinal: 0, 
    optional: false, repeating: false, completion: "", note: "", children: [] };
}

function newCommonItem(nullVar) {
  return {
    type: C_COMMON_ITEM, label: "", id: "", namespace: "", ordinal: 0, 
    optional: false, completion: "", note: "", bridg_path: "", item_refs: [], children: [] };
}

function newQuestion(nullVar) {
  return {
    type: C_QUESTION, label: "", id: "", namespace: "", ordinal: 0, 
    optional: false, completion: "", note: "", free_text: "", label_text: "", datatype: "I",
    format: "3", question_text: "", pText: "", mapping: "",
    children: [] 
  };
}

function newMapping(nullVar) {
  return {
    type: C_MAPPING, label: "", id: "", namespace: "", ordinal: 0, 
    optional: false, completion: "", note: "", mapping: "",
    children: [] 
  };
}

function newPlaceholder(nullVar) {
  return {
    type: C_PLACEHOLDER, label: "", id: "", namespace: "", ordinal: 0, 
    optional: false, completion: "", note: "", free_text: "", label_text: "",datatype: "",
    format: "", question_text: "", pText: "", mapping: "",
    children: [] 
  };
}

function newLabelText(nullVar) {
  return {
    type: C_TEXTLABEL, label: "", id: "", namespace: "", ordinal: 0, 
    optional: false, completion: "", note: "", free_text: "", label_text: "",datatype: "",
    format: "", question_text: "", pText: "", mapping: "",
    children: [] 
  };
}

function newBCGroup(bc) {
  return {
    type: C_NORMAL_GROUP, label: "", id: "", namespace: "", ordinal: 0, 
    repeating: false, completion: "", note: "", 
    bc_ref: 
      { 
        enabled: true, 
        optional: false,
        ordinal: 0, 
        local_label: "",
        subject_ref: {id: bc.id, namespace: bc.namespace},
        subject_data: bc
      },
    children: [] };
}

function newBCProperty(property) {
  return {
    type: C_BC_QUESTION, label: "", id: "", namespace: "", ordinal: 0, 
    is_common: false, completion: "", note: "",
    property_ref: 
      { 
        enabled: true, 
        optional: false,
        ordinal: 0, 
        local_label: "",
        subject_ref: {id: property.id, namespace: property.namespace},
        subject_data: property
      },
    children: [] 
  };
}

function newBCPropertyCli(cli) {
  return {
    type: C_TC_REF, label: "", id: "", namespace: "", ordinal: 0, 
    local_label: cli.Local_label, enabled: true, optional: false,
    subject_ref: {id: cli.subject_ref.id, namespace: cli.subject_ref.namespace},
  };
}

function newQuestionCli(cli) {
  return {
    type: C_TC_REF, label: "", id: "", namespace: "", ordinal: 0, 
    local_label: cli.useful_2, enabled: true, optional: false, 
    subject_ref: {id: cli.subject_ref.uri_id, namespace: cli.subject_ref.uri_ns}
  };
}

function addGroup(d3ParentNode) {
  var d3Node = addD3Node(d3ParentNode, C_NORMAL_GROUP, "Group", newFormGroup, null, true);
  addSNode(d3ParentNode.data, d3Node.data, true);
  return d3Node;
}

function addCommonGroup(d3ParentNode) {
  var d3Node = addD3Node(d3ParentNode, C_COMMON_GROUP, "Common Group", newCommonGroup, null, false);
  addSNode(d3ParentNode.data, d3Node.data, false);
  return d3Node;
}

function addCommonItem(d3ParentNode, label) {
  var d3Node = addD3Node(d3ParentNode, C_COMMON_ITEM, label, newCommonItem, null, true, true);
  addSNode(d3ParentNode.data, d3Node.data, false);
  return d3Node;
}

function addQuestion(d3ParentNode) {
  var d3Node = addD3Node(d3ParentNode, C_QUESTION, "Question", newQuestion, null, true, true);
  addSNode(d3ParentNode.data, d3Node.data, true);
  return d3Node;
}

function addMapping(d3ParentNode) {
  var d3Node = addD3Node(d3ParentNode, C_MAPPING, "Mapping", newQuestion, null, true, true);
  addSNode(d3ParentNode.data, d3Node.data, true);
  return d3Node;
}

function addPlaceholder(d3ParentNode) {
  var d3Node = addD3Node(d3ParentNode, C_PLACEHOLDER, "Placeholder", newPlaceholder, null, true, true);
  addSNode(d3ParentNode.data, d3Node.data, true);
  return d3Node;
}

function addLabelText(d3ParentNode) {
  var d3Node = addD3Node(d3ParentNode, C_TEXTLABEL, "Label Text", newLabelText, null, true, true);
  addSNode(d3ParentNode.data, d3Node.data, true)
  return d3Node;
}

function addBc(d3ParentNode) {
  var data = bcSelect.row(bcCurrentRow).data();
  $.ajax({
    url: "/biomedical_concepts/" + data.id,
    data: { "id": data.id, "namespace": data.namespace },
    dataType: 'json',
    error: function (xhr, status, error) {
      var html = alertError("An error has occurred loading the Biomedical Concept.");
      displayAlerts(html);
    },
    success: function(result){
      var bc = $.parseJSON(JSON.stringify(result));
      var bcD3Node = addD3Node(d3ParentNode, C_NORMAL_GROUP, bc.label, newBCGroup, bc, true, false);
      addSNode(d3ParentNode.data, bcD3Node.data, true)
      for (var i=0; i<bc.children.length; i++) {
        var property = bc.children[i];
        if (property.enabled && property.collect) {
          var propertyD3Node = addD3Node(bcD3Node, C_BC_QUESTION, property.alias, newBCProperty, property, true, false);
          addSNode(bcD3Node.data, propertyD3Node.data, true)
          for (var j=0; j<property.children.length; j++) {
            var tcRef = property.children[j];
            var tcRefD3Node = addD3Node(propertyD3Node, C_TC_REF, tcRef.local_label, newBCPropertyCli, tcRef, true, false);
            tcRefD3Node.enabled = true    
            addSNode(propertyD3Node.data, tcRefD3Node.data, true);
            getReference(tcRefD3Node);
          }
        }
      }
      if (hasCommonGroup(d3ParentNode)) {
        var commonNode = d3ParentNode.save[0];
        if (hasChildren(commonNode)) {
          for (var i=0; i<commonNode.save.length; i++) {
            var d3CommonItem = commonNode.save[i];
            for (var j=0; j<bcD3Node.save.length; j++) {
              var item = bcD3Node.save[j];
              if (d3CommonItem.bridg_path === item.data.property_ref.subject_data.bridg_path) {
                refFromCommon(d3CommonItem, item);
              }
            }
          }
        }
      }
    }
  });
}

function addD3Node(d3ParentNode, type, label, newFunction, functionData, atEnd, addCount=false) {
  var count;
  var text;
  if (addCount) {
    if (hasChildren(d3ParentNode)) {
      count = d3ParentNode.save.length + 1;
    } else {
      count = 1;
    }
    text = label + " " + count;
  } else {
    text = label;
  }
  var sNode = newFunction(functionData);
  sNode.label = text
  var d3Node = d3eAddNode(d3ParentNode, text, type, true, sNode, atEnd);   
  return d3Node
}

function addSNode(parent, node, end) {
  if (end) {
    parent.children.push(node);
  } else {
    parent.children.unshift(node);
  }
  for (i=0; i<parent.children.length; i++) {
    parent.children[i].ordinal = i + 1;
  }
}

/*
* Other utility functions
*/
function handleBCTable(table, ref) {
  if (bcCurrent != null) {
    $(bcCurrent).toggleClass('success');
  }
  $(ref).toggleClass('success');
  var row = table.row(ref).index();
  var data = table.row(row).data();
  bcCurrent = ref;
  bcCurrentRow = row;
}

function handleQuestionTable(table, ref) {
  if (varClCurrent != null) {
    $(varClCurrent).toggleClass('success');
  }
  $(ref).toggleClass('success');
  var row = table.row(ref).index();
  var data = table.row(row).data();
  varClCurrent = ref;
  varClCurrentRow = row;
}

function findNodeFromId(id) {
  if (idKeyMap.hasOwnProperty(id)) {
    return idKeyMap[id];
  } else {
    displayError("An error has occurred finding a node from an id.");
    return null;
  }
}

function initData () {
  var managedItem;
  var html = $("#formJson").html();
  formDefinition = $.parseJSON(html);
  managedItem = formDefinition.managed_item;
  previousSave = currentSave = JSON.stringify(formDefinition);
  markdownElement = null;
  markdownType = "";
  bcCurrent = null;
  bcCurrentRow = null;
  notepadTableReload = false;
  notepadData = null;
  notepadRow = null; 
  varClCurrent = null;
  varClCurrentRow = null;
  questionDatatypeValue = "I";
  d3eInit(saveNode, displayNode, empty);
  rootNode = d3eRoot(managedItem.label, C_FORM, managedItem)
  idKeyMap = {};
  for (var i=0; i<managedItem.children.length; i++) {
    setD3(managedItem.children[i], rootNode);
  }
}

function empty(node) {
}

/*
* Set the D3 Structures
*
* @param sourceNode [Object] The data node
* @param d3ParentNode [Object] The parent D3 node
* @return [Null]
*/
function setD3(sourceNode, d3ParentNode) {
  var newNode = d3eAddNode(d3ParentNode, sourceNode.label, sourceNode.type, true, sourceNode, true);
  getReference(newNode);
  if (sourceNode.hasOwnProperty('children')) {
    for (var i=0; i<sourceNode.children.length; i++) {
      var child = sourceNode.children[i];
      setD3(child, newNode);
    }
  }
}

function saveNode() {
  $('#main_form').valid(); // Won't return if invalid.
  var d3Node = d3eGetCurrent();
  if (d3Node.type == C_FORM) {
    saveForm(d3Node)
  } else if (d3Node.type == C_NORMAL_GROUP) {
    if (!isBcGroup(d3Node)) {
      saveGroup(d3Node)
    }
  } else if (d3Node.type == C_COMMON_GROUP) {
    saveCommon(d3Node)
  } else if (d3Node.type == C_PLACEHOLDER) {
    savePlaceholder(d3Node)
  } else if (d3Node.type == C_TEXTLABEL) {
    saveLabelText(d3Node)
  } else if (d3Node.type == C_QUESTION) {
    saveQuestion(d3Node)
  } else if (d3Node.type == C_MAPPING) {
    saveMapping(d3Node)
  } else if (d3Node.type == C_TC_REF) {
    saveCl(d3Node)
  } 
  //saveRest();
}

function displayNode(d3Node) {
  d3eDisplayTree(d3Node.key);
  if (d3Node.type ==  C_FORM ) {
    selectForm();
    displayForm(d3Node);
  } else if (d3Node.type == C_NORMAL_GROUP) {
    if (!isBcGroup(d3Node)) {
      selectGroup();
      displayGroup(d3Node);
    } else {
      selectBC();
      displayBC(d3Node);
    }
  } else if (d3Node.type == C_COMMON_GROUP) {
    selectCommon();
    displayCommon(d3Node);
  } else if (d3Node.type == C_BC_QUESTION) {
    selectItem();
    displayItem(d3Node);
  } else if (d3Node.type == C_QUESTION) {
    questionClTable.clear();
    selectQuestion();
    displayQuestion(d3Node);
    questionClTable.draw(false);
  } else if (d3Node.type == C_MAPPING) {
    selectMapping();
    displayMapping(d3Node);
  } else if (d3Node.type == C_COMMON_ITEM) {
    selectItem();
    displayItem(d3Node);
  } else if (d3Node.type == C_PLACEHOLDER) {
    selectPlaceholder();
    displayPlaceholder(d3Node);
  } else if (d3Node.type == C_TEXTLABEL) {
    selectLabelText();
    displayLabelText(d3Node);
  } else if (d3Node.type == C_TC_REF) {
    selectCl();
    displayCl(d3Node);
  } 
}

/*
* Get Reference
*
* @param node [Object] The D3 node
* @return [Null]
*/
function getReference(d3Node) {
  if (d3Node.type == C_TC_REF) {
    getThesaurusConcept(d3Node, tcResult)
  } else if (d3Node.type == C_BC_QUESTION) {
    getBcProperty(d3Node, bcPropertyResult)
  } else if (d3Node.type == C_COMMON_ITEM) {
    if (d3Node.data.item_refs.length > 0) {
      getBcPropertyCommon(d3Node, bcPropertyResultCommon)
    }
  } 
}

/*
* Thesaurus Ref AJAX Result Callback
*
* @param node [Object] The D3 node
* @param result [Object] Result received from server
* @return [Null]
*/
function tcResult(d3Node, result) {
  d3Node.data.subject_data = result;
  d3Node.name = result.label;
  displayNode(rootNode);
}

/*
* BC Property Ref AJAX Result Callback for BC Property
*
* @param node [Object] The D3 node
* @param result [Object] Result received from server
* @return [Null]
*/
function bcPropertyResult(d3Node, result) {
  d3Node.data.property_ref.subject_data = result;
  idKeyMap[d3Node.data.property_ref.subject_ref.id] = d3Node.key;
  var parent = d3Node.parent;
  var group = d3Node.parent.parent;
  displayNode(group);
}

/*
* BC Property Ref AJAX Result Callback for Common Item
*
* @param node [Object] The D3 node
* @param result [Object] Result received from server
* @return [Null]
*/
function bcPropertyResultCommon(d3Node, result) {
  d3Node.data.bridg_path = result.bridg_path;
  if (!hasChildren(d3Node)) {
    for (var i=0; i<result.children.length; i++) {
      setD3(result.children[i], d3Node);
    }
  }
}