$(document).ready(function() {
  
  var C_FORM = "Form";
  var C_GROUP ="Group";
  var C_COMMON_GROUP = "CommonGroup";
  var C_PLACEHOLDER = "Placeholder";
  var C_BC_GROUP = "BCGroup";
  var C_BC_ITEM = "BCItem";
  var C_QUESTION = "Question";
  var C_CL = "CL";

  var formDefinition ;
  var html;
  var d3Div;

  var formIdentifierElement = document.getElementById("formIdentifier");
  var formLabelElement = document.getElementById("formLabel");
  var formCompletionElement = document.getElementById("formCompletion");
  var formNoteElement = document.getElementById("formNote");
  var groupLabelElement = document.getElementById("groupLabel");
  var groupCompletionElement = document.getElementById("groupCompletion");
  var groupNoteElement = document.getElementById("groupNote");
  var groupRepeatingElement = document.getElementById("groupRepeating");
  var groupOptionalElement = document.getElementById("groupOptional");
  var commonIdentifierElement = document.getElementById("commonIdentifier");
  var commonLabelElement = document.getElementById("commonLabel");
  var bcIdentifierElement = document.getElementById("bcIdentifier");
  var bcLabelElement = document.getElementById("bcLabel");
  var itemLabelElement = document.getElementById("itemLabel");
  var itemEnableElement = document.getElementById("itemEnable");
  var itemOptionalElement = document.getElementById("itemOptional");
  var clIdentifierElement = document.getElementById("clIdentifier");
  var clLabelElement = document.getElementById("clLabel");
  var clEnableElement = document.getElementById("clEnable");
  var clOptionalElement = document.getElementById("clOptional");
  var plTextElement = document.getElementById("placeholderText");
  var questionLabelElement = document.getElementById("questionLabel");
  var questionTextElement = document.getElementById("questionText");
  var questionMappingElement = document.getElementById("questionMapping");
  var questionDatatypeElement = document.getElementById("questionDatatype");
  var questionFormatElement = document.getElementById("questionFormat");
  var questionCompletionElement = document.getElementById("questionCompletion");
  var questionNoteElement = document.getElementById("questionNote");
  var questionOptionalElement = document.getElementById("questionOptional");
  var genericCompletionElement = document.getElementById("genericCompletion");
  
  var nextKeyId;
  var currentNode;
  var currentGRef;
  var rootNode;
  var bcCurrent;
  var bcCurrentRow;
  var notepadTableReload;
  var norepadTable;
  var notepadData;
  var notepadRow;
  var varClCurrent;
  var varClCurrentRow;
  var questionDatatypeValue
  var editIdentifierFlag;               
  var markdownElement;
  var markdownType;

  // Set up the form validation
  validatorDefaults ();
  $('#main_form').validate({
    rules: {
        formIdentifier: {required: true, identifier: true },
        "Form Label": {required: true, label: true },
        formNote: {required: false, markdown: true},
        formCompletion: {required: false, markdown: true},
        groupLabel: {required: true, label: true },
        groupNote: {required: false, markdown: true},
        groupCompletion: {required: false, markdown: true},
        "Question Label": {required: true, label: true },
        "Question Text": {required: true, question: true },
        questionNote: {required: false, markdown: true},
        questionCompletion: {required: false, markdown: true},
        commonLabel: {required: true, label: true }
    },
    submitHandler: function(form) {
      formSave();
      return false;
    },
    invalidHandler: function(event, validator) {
      var html = alertWarning("The form is not valid. Please correct the errors.");
      displayAlerts(html);
    }
  });

  questionClTable = $('#questionClTable').DataTable({
    "searching": false,
    "pageLength": 5,
    "lengthChange": false,
    "columns": [
      {"data" : "identifier", "width" : "50%"},
      {"data" : "useful_1", "width" : "50%"},
    ]
  });
  questionClTable.clear();

  var bcSelect = $('#bcTable').DataTable( {
    "ajax": {
      "url": "/biomedical_concepts/list",
      "dataSrc": "data",
      error: function (xhr, status, error) {
        var html = alertError("An error has occurred loading the Biomedical Concepts table.");
        displayAlerts(html);
      }
    },
    dataType: 'json',
    "pageLength": 5,
    "lengthMenu": [[5, 10, 25, 50], [5, 10, 25, 50]],
    "pagingType": "full",
    "bProcessing": true,
    "language": {
      "infoFiltered": "",
      "processing": "<img src='<%= asset_path('processing.gif') %>'>"
    },
    "columns": [
      {"data" : "identifier", "width" : "50%"},
      {"data" : "label", "width" : "50%"}
    ]
  });

  function initialNotepadLoad () {
    notepadTable = $('#notepad_table').DataTable( {
      "ajax": {
        "url": "/notepads/index_term",
        "dataSrc": "data"  
      },
      "bProcessing": true,
      "bInfo" : false,
      "searching": false,
      "pageLength": 5,
      "lengthMenu": [[5, 10, 15, 20, 25], [5, 10, 15, 20, 25]],
      "language": {
             "processing": "<img src='<%= asset_path('processing.gif') %>'>"
        },
      "columns": [
        {"data" : "identifier", "width" : "30%"},
        {"data" : "useful_1", "width" : "70%"}
      ]
    });
    notepadTableReload = true;    
  }

  $('#notepad_refresh').click(function() {
    if (!notepadTableReload) {
      initialNotepadLoad();
    } else {
      notepadTable.ajax.reload();
    }
  });

  $('#notepad_add').click(function() {
    var data;
    var text;
    if (notepadRow != null) {
      data = notepadTable.row(notepadRow).data();
      questionClTable.row.add(data);
      questionClTable.draw(false);
    }
  });

  $('#notepad_table tbody').on('click', 'tr', function () {
    var row = notepadTable.row(this).index();
    var data = notepadTable.row(row).data();
    if (notepadRow != null) {
      $(notepadRow).toggleClass('success');
    }
    $(this).toggleClass('success')
    notepadData = data;
    notepadRow = this
  });

  // Get elements from the form.
  d3Div = document.getElementById("d3");
  
  // Init any data
  initData();

  // Draw the initial tree and select the form.
  initialNotepadLoad();
  setRoot();

  /**
   * Function to handle click on the D3 tree.
   * Show the node info. Highlight the node.
   */
  function click(node) {    
    if (currentGRef != null) {
      clearNode(currentNode, currentGRef);
      if (currentNode.type == C_FORM) {
        saveForm(currentNode)
      } else if (currentNode.type == C_GROUP) {
        saveGroup(currentNode)
      } else if (currentNode.type == C_COMMON_GROUP) {
        saveCommon(currentNode)
      } else if (currentNode.type == C_PLACEHOLDER) {
        savePlaceholder(currentNode)
      } else if (currentNode.type == C_QUESTION) {
        saveQuestion(currentNode)
      }
    }
    displayNode(node)
    markNode1(this);
    currentGRef = this;
    currentNode = node;
  }  

  /**
   * Function to handle double click on the D3 tree.
   * Expand/delete the node clicked.
   */
  function dblClick(node) {
    if (node.expand) {
      node.children = node.save;
      node.expand = false;
      displayTree(node.key);
    } else if (node.hasOwnProperty('children')) {
      node.children = [];
      node.expand = true;
      displayTree(node.key); 
    }
    /*if (node.hasOwnProperty('children')) {
      node.children = [];
      node.expand = true;
      displayTree(node.key);
    } else if (node.hasOwnProperty('save')) {
      node.children = [];
      node.children = node.save;
      node.expand = false;
      displayTree(node.key);
    }*/
  } 

  /* 
  * Function to handle the form save click.
  */
  function formSave() {
    var uri;
    var method;
    var data;
    var action;
    var form;
    action = formDefinition.operation.action;
    form = formDefinition.managed_item;
    
    if (action === "CREATE") {
      url = "/forms";
      method = 'POST';
      data = { "data": formDefinition };  
    } else {
      url = "/forms/" + form['id'];
      method = 'PUT';
      data = { "namespace": form['namespace'], "data": formDefinition };  
    }
    $.ajax({
      url: url,
      type: method,
      data: data,
      success: function(result){
        var html = alertSuccess("Form has been saved.");
        displayAlerts(html);
        
        // Indicate now edit. Stops identifier being modified. Probably
        // a better way to do this, existing function.
        editIdentifierFlag = false;
        formIdentifierElement.disabled = true;

        // Save the URI of the saved form.
        var managedItem = result.data.managed_item;
        formDefinition.operation.action = "UPDATE";
        formDefinition.managed_item.id = managedItem.id;
        formDefinition.managed_item.namespace = managedItem.namespace;
      },
      error: function(xhr, status, error){
        handleAjaxError (xhr, status, error);
      }
    }); 
  }

  /*
   * Functions to handle the form actions.
   */
  $('#formUpdate').click(function() {
    if (currentGRef == null) {
      var html = alertWarning("You need to select the form node.");
      displayAlerts(html);
    } else {
      //if ($('#main_form').valid()) {
        $('#main_form').valid();
        saveForm(currentNode);
        displayTree(currentNode.key);
      //} else {
      //  var html = alertWarning("Not saved, correct the errors.");
      //  displayAlerts(html);
      //}
    }
  });

  $('#formAddGroup').click(function() {
    if (currentGRef == null) {
      var html = alertWarning("You need to select the form node.");
      displayAlerts(html);
    } else {
      var node = addGroup();
      displayNode(node);
      displayTree(node.key);  
    }
  });

  /*
  * Functions to handle the group actions
  */
  $('#groupUpdate').click(function() {
    if (currentGRef == null) {
      var html = alertWarning("You need to select a group node.");
      displayAlerts(html);
    } else {
      //if ($('#main_form').valid()) {
        $('#main_form').valid();
        saveGroup(currentNode)
        displayTree(currentNode.key);
      //} else {
      //  var html = alertWarning("Not saved, correct the errors.");
      //  displayAlerts(html);
      //}
    }
  });
  
  $('#groupAddGroup').click(function() {
    if (currentGRef == null) {
      var html = alertWarning("You need to select a group node.");
      displayAlerts(html);
    } else {
      var node = addGroup();
      displayNode(node);
      displayTree(node.key);  
    }
  });

  $('#groupDelete').click(function() {
    if (hasChildren(currentNode)) {
      var html = alertWarning("You need to delete the child nodes.");
      displayAlerts(html);
    } else {
      var node = deleteNode(currentNode);
      displayNode(node);
      displayTree(node.key);
    }     
  });

  $('#groupAddCommon').click(function() {
    if (currentNode == null) {
      var html = alertWarning("You need to select a group node.");
      displayAlerts(html);
    } else if (hasCommon(currentNode)) {
      var html = alertWarning("Group already has a common node.");
      displayAlerts(html);
    } else {
      var node = addCommon();
      displayNode(node);
      displayTree(node.key);
    }
  }); 

  $('#groupAddBc').click(function() {
    if (currentNode == null) {
      var html = alertWarning("You need to select a group node.");
      displayAlerts(html);
    } else if (bcCurrent ==  null) {
      var html = alertWarning("You need to select a Biomedical Concept.");
      displayAlerts(html);
    } else {
      addBc();
    }
  }); 

  $('#groupAddQuestion').click(function() {
    if (currentNode == null) {
      var html = alertWarning("You need to select a group node.");
      displayAlerts(html);
    } else {
      node = addQuestion();
      displayNode(node);
      displayTree(node.key);
    }
  }); 

  $('#groupAddPlaceholder').click(function() {
    if (currentNode == null) {
      var html = alertWarning("You need to select a group node.");
      displayAlerts(html);
    } else {
      node = addPlaceholder();
      displayNode(node);
      displayTree(node.key);
    }
  }); 

  $('#groupUp').click(function() {
    if (currentNode == null) {
      var html = alertWarning("You need to select a group node.");
      displayAlerts(html);
    } else {
      var parentNode = currentNode.parent;
      if (currentNode.index != 0) {
        moveNodeUp(currentNode);
        displayNode(currentNode);
        displayTree(currentNode.key);
      } else {
        var html = alertWarning("You cannot move the node up.");
        displayAlerts(html);
      }
    }
  }); 

  $('#groupDown').click(function() {
    if (currentNode == null) {
      var html = alertWarning("You need to select a group node.");
      displayAlerts(html);
    } else {
      var parentNode = currentNode.parent;
      if (currentNode.index < parentNode.save.length) {
        moveNodeDown(currentNode);
        displayNode(currentNode);
        displayTree(currentNode.key);
      } else {
        var html = alertWarning("You cannot move the node down.");
        displayAlerts(html);
      }
    }
  }); 

  /*
  * Functions to handle the common actions
  */
  $('#commonUpdate').click(function() {
    if (currentGRef == null) {
      var html = alertWarning("You need to select a common node.");
      displayAlerts(html);
    } else {
      //if ($('#main_form').valid()) {
        $('#main_form').valid();
        saveCommon(currentNode)
        displayTree(currentNode.key);
      //} else {
      //  var html = alertWarning("Not saved, correct the errors.");
      //  displayAlerts(html);
      //}
    }
  });
  
  $('#commonDelete').click(function() {
    notImplementedYet();    
    /*if (currentNode.hasOwnProperty('save')) {
      var html = alertWarning("You need to remove the child nodes.");
      displayAlerts(html);
    } else {
      var node = deleteNode(currentNode);
      displayNode(node);
      displayTree(node.key);
    } */    
  });

  /*
  * Functions to handle the question actions
  */
  $('#questionUpdate').click(function() {
    if (currentGRef == null) {
      var html = alertWarning("You need to select a question node.");
      displayAlerts(html);
    } else {
      $('#main_form').valid();
      saveQuestion(currentNode)
      displayTree(currentNode.key);
    }
  });
  
  $('#questionDelete').click(function() {
    var node = deleteNode(currentNode);
    displayNode(node);
    displayTree(node.key);
  });

  /*
  * Functions to handle the placeholder actions
  */
  $('#placeholderUpdate').click(function() {
    if (currentGRef == null) {
      var html = alertWarning("You need to select a placeholder node.");
      displayAlerts(html);
    } else {
      $('#main_form').valid();
      savePlaceholder(currentNode)
      displayTree(currentNode.key);
    }
  });
  
  $('#placeholderDelete').click(function() {
    var node = deleteNode(currentNode);
    displayNode(node);
    displayTree(node.key);
  });

  /*
  * Functions to handle the BC actions
  */
  $('#bcDelete').click(function() {
    notImplementedYet();     
  });

  /*
  * Functions to handle the item actions
  */
  $('#itemUpdate').click(function() {
    if (currentGRef == null) {
      var html = alertWarning("You need to select a group node.");
      displayAlerts(html);
    } else {
      saveItem(currentNode);
      displayTree(currentNode.key);
    }
  });
  
  $('#itemCommon').click(function() {
    if (currentNode == null) {
      var html = alertWarning("You need to select an item node.");
      displayAlerts(html);
    } else {
      makeCommon(currentNode);
    }
  }); 

  $('#itemRestore').click(function() {
    if (currentNode == null) {
      var html = alertWarning("You need to select an item node.");
      displayAlerts(html);
    } else {
      restoreCommon(currentNode);
      //notImplementedYet();
    }
  }); 

  /*
  * Functions to handle the code list items actions
  */
  $('#clUpdate').click(function() {
    if (currentNode == null) {
      var html = alertWarning("You need to select a group node.");
      displayAlerts(html);
    } else {
      saveCl(currentNode)
      //clIdentifierElement.innerHTML = node.data.identifier;
    }
  });
  
  /*
   * Function to handle click on the BC selection table.
   */
  $('#bcTable tbody').on('click', 'tr', function () {
    handleBCTable(bcSelect, this);
  });

  /*
   * Function to handle click on question cl table
   */
  $('#questionClTable tbody').on('click', 'tr', function () {
    handleQuestionTable(questionClTable, this);
  });

  /* 
  * Function to handle the terminology button clicks.
  */
  $('#deleteTerm').click(function() {
    var data;
    if (varClCurrentRow == null) {
      var html = alertWarning("You need to select a code list item.");
      displayAlerts(html);
    } else {
      questionClTable.row(varClCurrentRow).remove();
      varClCurrentRow = null;
      questionClTable.draw();
    }
  });

  $('#questionDatatype input:radio').click(function() {
    var value = $(this).val();
    clEnableDisable(value);
    clFormat(value);
    questionDatatypeValue = value;
  });

  /*
  * Functions to handle completion instruction preview
  */
  $('#markdown_preview').click(function() {
    if (markdownElement == null) {
      var html = alertWarning("You need to select a completion instruction field.");
      displayAlerts(html);
    } else {
      var text = markdownElement.value;
      markdown(text);  
    }
  });

  $('#markdown_hide').click(function() {
    hideCi();
    if (markdownType == C_GROUP) {
      showBCSelection();
    } else if (markdownType == C_QUESTION) {
      showNotepad();    
    }
    markdownElement = null;
    markdownType = "";
  });

  /*
  * Completion and notes focus functions
  */
  $( "#formCompletion" ).focus(function() {
    showCi();
    markdownType = C_FORM;
    markdownElement = formCompletionElement;
    var text = markdownElement.value;
    markdown(text); 
  });

  $( "#formNote" ).focus(function() {
    showCi();
    markdownType = C_FORM;
    markdownElement = formNoteElement;
    var text = markdownElement.value;
    markdown(text); 
  });

  $( "#groupCompletion" ).focus(function() {
    hideBCSelection();
    showCi();
    markdownType = C_GROUP;
    markdownElement = groupCompletionElement;
    var text = markdownElement.value;
    markdown(text); 
  });

  $( "#groupNote" ).focus(function() {
    hideBCSelection();
    showCi();
    markdownType = C_GROUP;
    markdownElement = groupNoteElement;
    var text = markdownElement.value;
    markdown(text); 
  });

  $( "#questionCompletion" ).focus(function() {
    hideNotepad();
    showCi();
    markdownType = C_QUESTION;
    markdownElement = questionCompletionElement;
    var text = markdownElement.value;
    markdown(text); 
  });

  $( "#questionNote" ).focus(function() {
    hideNotepad();
    showCi();
    markdownType = C_QUESTION;
    markdownElement = questionNoteElement;
    var text = markdownElement.value;
    markdown(text); 
  });

  /*
  *
  */
  function clEnableDisable (value) {
    if (value == "I" || value == "C" || value == "F") {
      $("#questionFormat").prop('disabled', false);
      $("#notepad_add").prop('disabled', true);
      $("#deleteTerm").prop('disabled', true);
    } else {
      $("#questionFormat").prop('disabled', true);
      $("#notepad_add").prop('disabled', false);
      $("#deleteTerm").prop('disabled', false);
    }
  }

  function clFormat (value) {
    if (value == "I") {
      questionFormatElement.value = "3"
    } else if (value == "C") {
      questionFormatElement.value = "20"
    } else if (value == "F") {
      questionFormatElement.value = "6.2"
    } else {
      questionFormatElement.value = ""
    }
  }

  
  /* ****************
  * Utility Functions
  */
  function selectForm() {
    clearSelect();
    $("#formInfo").removeClass('hidden');
  }

  function selectGroup() {
    clearSelect();
    $("#groupInfo").removeClass('hidden');
    $("#bcSelection").removeClass('hidden');
  }
  
  function selectBC() {
    clearSelect();
    $("#bcInfo").removeClass('hidden');
  }
  
  function showBCSelection() {
    $("#bcSelection").removeClass('hidden');
  }
  
  function hideBCSelection() {
    $("#bcSelection").addClass('hidden');
  }
  
  function selectCommon() {
    clearSelect();
    $("#commonInfo").removeClass('hidden');
  }
  
  function selectItem() {
    clearSelect();
    $("#itemInfo").removeClass('hidden');
  }

  function selectQuestion() {
    clearSelect();
    $("#questionInfo").removeClass('hidden');
    $("#notepad_panel").removeClass('hidden');
  }

  function selectPlaceholder() {
    clearSelect();
    $("#placeholderInfo").removeClass('hidden');
  }

  function selectCl() {
    clearSelect();
    $("#clInfo").removeClass('hidden');
  }

  function showNotepad() {
    $("#notepad_panel").removeClass('hidden');
  }

  function hideNotepad() {
    $("#notepad_panel").addClass('hidden');
  }

  function showCi() {
    $("#markdown_panel").removeClass('hidden');
  }

  function hideCi() {
    $("#markdown_panel").addClass('hidden');
  }

  function clearSelect() {
    $("#formInfo").addClass('hidden');
    $("#groupInfo").addClass('hidden');
    $("#bcInfo").addClass('hidden');
    $("#commonInfo").addClass('hidden');
    $("#questionInfo").addClass('hidden');
    $("#placeholderInfo").addClass('hidden');
    $("#itemInfo").addClass('hidden');
    $("#clInfo").addClass('hidden');
    $("#bcSelection").addClass('hidden');
    $("#notepad_panel").addClass('hidden');
    $("#markdown_panel").addClass('hidden');
  }

  /**
   * Functions to display the various panels. 
   */
  function displayForm(node) {
    formIdentifierElement.value = node.data.identifier;
    formLabelElement.value = node.data.label;
    formCompletionElement.value = node.data.formCompletion;
    formNoteElement.value = node.data.formNote;
    if (editIdentifierFlag) {
      formIdentifierElement.disabled = false;
    } else {
      formIdentifierElement.disabled = true;      
    }
  }

  function displayGroup(node) {
    groupLabelElement.value = node.data.label;
    groupCompletionElement.value = node.data.completion;
    groupNoteElement.value = node.data.note;
    groupRepeatingElement.checked = node.data.repeating;
    groupOptionalElement.checked = node.data.optional;
  }

  function displayBC(node) {
    bcIdentifierElement.innerHTML = node.data.biomedical_concept_reference.identifier;
    bcLabelElement.innerHTML = node.data.label;
  }

  function displayCommon(node) {
    //commonIdentifierElement.value = node.data.identifier;
    commonLabelElement.value = node.data.label;
  }

  function displayItem(node) {
    var parentNode;
    //itemIdentifierElement.innerHTML = node.data.identifier;
    itemLabelElement.innerHTML = node.data.label;
    parentNode = node.parent;
    if (isCommon(parentNode)) {
      $("#itemEnable").prop('disabled', true);
      $("#itemOptional").prop('disabled', true);
      $("#itemUpdate").prop('disabled', true);
      $("#itemCommon").prop('disabled', true);
      $("#itemRestore").prop('disabled', false);
    } else {
      $("#itemEnable").prop('disabled', false);
      $("#itemOptional").prop('disabled', false);
      $("#itemUpdate").prop('disabled', false);
      $("#itemCommon").prop('disabled', false);
      $("#itemRestore").prop('disabled', true);
      itemEnableElement.checked = node.data.property_reference.reference.enabled;
      itemOptionalElement.checked = node.data.property_reference.reference.optional;
    }
  }

  function displayQuestion(node) {
    questionLabelElement.value = node.data.label;
    questionTextElement.value = node.data.qText;
    questionOptionalElement.checked = node.data.optional;
    questionMappingElement.value= node.data.mapping;
    var $radios = $('input:radio[name=dtRadio]');
    $radios.filter('[value=' + node.data.datatype +']').prop('checked', true);
    questionFormatElement.value = node.data.format;
    questionCompletionElement.value = node.data.completion;
    questionNoteElement.value = node.data.note;
    questionClTable.clear();
    if (node.hasOwnProperty('children')) {
      for (j=0; j<node.children.length; j++) {
        var child = node.children[j];
        var data = child.data
        var ref = data.reference;
        var clRow = { identifier: data.identifier , uri_id: ref.id , uri_ns: ref.namespace , useful_1: data.label}; 
        questionClTable.row.add(clRow);
      }
    }
    clEnableDisable(node.data.datatype);
  }

  function displayPlaceholder(node) {
    plTextElement.value = node.data.free_text;
  }

  function displayCl(node) {
    clIdentifierElement.innerHTML = node.data.identifier;
    clLabelElement.innerHTML = node.data.label;
    clEnableElement.checked = node.data.reference.enabled;
    clOptionalElement.checked = node.data.reference.optional;
    parentNode = node.parent;
    if (parentNode.type == C_QUESTION) {
      $("#clEnable").prop('disabled', true);
    } else {
      $("#clEnable").prop('disabled', false);
    }
  }

  /**
   * Functions to save info.
   */
  function saveForm(node) {
    if (editIdentifierFlag) {
      node.data.identifier = formIdentifierElement.value;
    }
    node.data.label = formLabelElement.value;
    node.data.formCompletion = formCompletionElement.value;
    node.data.formNote = formNoteElement.value;
    node.name = node.data.label;
  }

  function saveGroup(node) {
    node.data.label = groupLabelElement.value;
    node.data.completion = groupCompletionElement.value;
    node.data.note = groupNoteElement.value;
    node.name = node.data.label;
    node.data.repeating = groupRepeatingElement.checked;
    node.data.optional = groupOptionalElement.checked;
  }

  function saveCommon(node) {
    //node.data.identifier = commonIdentifierElement.value;
    node.data.label = commonLabelElement.value;
    node.name = node.data.label;
  }

  function saveItem(node) {
    node.data.property_reference.reference.enabled = itemEnableElement.checked;
    node.data.property_reference.reference.optional = itemOptionalElement.checked;
    node.enabled = itemEnableElement.checked;
  }

  function saveQuestion(node) {
    var rowData;
    var i;
    var row;
    var sourceCliNode;
    var cliNode;
    node.data.label = questionLabelElement.value;
    node.name = node.data.label;
    node.data.qText = questionTextElement.value;
    node.data.optional = questionOptionalElement.checked;
    node.data.mapping = questionMappingElement.value;
    node.data.datatype = $('input:radio[name=dtRadio]:checked').val();
    node.data.format = questionFormatElement.value;
    node.data.completion = questionCompletionElement.value;
    node.data.note = questionNoteElement.value;
    node.data.children = [];
    node.save = [];
    node.children = [];
    rowData = questionClTable.rows().data();
    for (i=0; i<rowData.length; i++) {
      row = rowData.row(i).data();
      sourceCliNode = newQuestionCli(row);
      cliNode = addD3Node(node, row.useful_1, C_CL, sourceCliNode, true); 
      addSourceNode(node.data, sourceCliNode, true);
    }
  }

  function savePlaceholder(node) {
    node.data.free_text = plTextElement.value;
  }

  function saveCl(node) {
    node.data.reference.enabled = clEnableElement.checked;
    node.data.reference.optional = clOptionalElement.checked;
    node.enabled = clEnableElement.checked;
  }

  function makeCommon(node) {
    var child;
    var item;
    var commonGroup;
    var otherNodes = [];
    var otherSourceNodes = [];
    var bcParent = node.parent;
    var groupParent = bcParent.parent;
    var sourceNode;
    if (bcParent != null && groupParent != null) {
      for (var i=0; i<groupParent.save.length; i++) {
        child = groupParent.save[i];
        if (child.type == C_COMMON_GROUP) {
          commonGroup = child;
        } else if (child.type == C_BC_GROUP) {
          for (var j=0; j<child.save.length; j++) {
            item = child.save[j];
            if ('bridgPath' in item.data) {
              if (node.key == item.key) {
                // Same node, ignore.
              } else if (node.data.bridgPath == item.data.bridgPath) {
                // Push to node for later
                otherNodes.push(item);
                otherSourceNodes.push(item.data);
              }
            }
          }
        }
      }

      // Node refers to the selected note, otherNodes all the nodes of
      // the same type within the BCs at the same level within parent group
      if (commonGroup != null) {
        sourceNode = node.data;

        node.otherCommon = [];
        sourceNode.otherCommon = [];
        if (!commonGroup.hasOwnProperty('save')) {
          commonGroup.children = [];
          commonGroup.save = [];
          commonGroup.data.children = [];
        }  
        
        // Move the clicked on node. Set the ordinals.
        detachForCommon(node);
        commonGroup.save.push(node);
        commonGroup.children = commonGroup.save;
        commonGroup.data.children.push(sourceNode);
        setOrdinal(commonGroup.data);

        // Move the other noted (found) nodes. Set the ordinals
        for (var k=0; k<otherNodes.length; k++) {
          var otherNode = otherNodes[k];
          detachForCommon(otherNode);
        } 
        node.otherCommon = otherNodes
        sourceNode.otherCommon = otherSourceNodes;
        setOrdinal(sourceNode.otherCommon);

        // Display the tree. Will need to set the parents in the new common group.
        setParent(commonGroup);
        displayNode(commonGroup);
        displayTree(commonGroup.key);  

      } else {
        var html = alertWarning("Common group not found within this group.");
        displayAlerts(html);
      }
    } else {
      if (bcParent == null && groupParent == null) {
        var html = alertWarning("Something has gone wrong! Cannot find Biomedical Concept and the Group parent nodes.");
      } else if (bcParent == null) {
        var html = alertWarning("Something has gone wrong! Cannot find Biomedical Concept parent nodes.");
      } else if (groupParent == null) {
        var html = alertWarning("Something has gone wrong! Cannot find Group parent nodes.");
      }
      displayAlerts(html);
    }
  }

  // Detaches the node from its 'natural' position
  function detachForCommon(node) {
    var sourceParent;
    var parent;
    parent = node.parent;
    sourceParent = parent.data;
    node.realParent = node.parent;
    parent.save.splice(node.index, 1);
    setParent(parent);
    sourceParent.children.splice(node.index, 1);
    setOrdinal(sourceParent);
  }

  // Restore from common to 'natural' position.
  function restoreCommon(node) {
    var item;
    var parentNode;
    var parentSourceNode;
    var index;

    // Restore the 'other' nodes. These are the copies.
    for (i=0; i<node.otherCommon.length; i++) {
      item = node.otherCommon[i];
      parentNode = item.realParent;
      parentSourceNode = parentNode.data;
      index = item.index;
      parentNode.save.splice(index, 0, item);
      parentSourceNode.children.splice(index, 0, item.data);
      setOrdinal(parentSourceNode);
    }

    // Restore the 'main' node.
    parentNode = node.realParent
    parentSourceNode = parentNode.data;
    index = node.index;
    parentNode.save.splice(index, 0, node);
    parentSourceNode.children.splice(index, 0, node.data);
    setOrdinal(parentSourceNode);

    // Delete the item from its current position and clean out the other
    // common nodes.
    node.otherCommon = [];
    node.data.otherCommon = [];
    deleteNode(node);

    // Draw the tree. Set the root as the selected node.
    setRoot();
  }

  /*
  * Group generic functions
  */
  function addGroup() {
    var sourceNode;
    var d3Node;
    var label;
    label = "Group";
    sourceNode = newFormGroup(label)
    d3Node = addD3Node(currentNode, label, C_GROUP, sourceNode, true);     
    addSourceNode(currentNode.data, sourceNode, true)
    return d3Node;
  }

  function addCommon(data) {
    var sourceNode;
    var d3Node;
    var label;
    label = "Common";
    sourceNode = newCommonGroup(label)
    d3Node = addD3Node(currentNode, label, C_COMMON_GROUP, sourceNode, false);     
    addSourceNode(currentNode.data, sourceNode, false)
    return d3Node;
 }

  function newFormGroup(label) {
    return { 
      id: "", namespace: "", type: C_GROUP, label: label, ordinal: 0, optional: false, repeating: false, 
      note: "", completion: "", biomedical_concept_reference: {}, children: [] };
  }

  function newCommonGroup(label) {
    return {
      id: "", namespace: "", type: C_COMMON_GROUP, label: label, ordinal: 0, 
      optional: false, repeating: false, completion: "", note: "", biomedical_concept_reference: {}, children: [] };
  }

  function newQuestion(label) {
    return {
      id: "", namespace: "", type: C_QUESTION, label: label, ordinal: 0, 
      optional: false, completion: "", note: "", free_text: "", datatype: "I",
      format: "3", qText: "", pText: "", mapping: "",
      //property_reference: {id: "", namespace: "", enabled: true, optional: false}, 
      children: [] 
    };
  }

  function newPlaceholder(label) {
    return {
      id: "", namespace: "", type: C_PLACEHOLDER, label: label, ordinal: 0, 
      optional: false, completion: "", note: "", free_text: "", datatype: "",
      format: "", qText: "", pText: "", mapping: "",
      //property_reference: {id: "", namespace: "", enabled: true, optional: false}, 
      children: [] 
    };
  }

  function newBCGroup(bc) {
    return {
      id: bc.id, namespace: bc.namespace, type: C_BC_GROUP, label: bc.label, ordinal: 0, 
      optional: bc.optional, repeating: bc.repeating, note: bc.note, 
      biomedical_concept_reference: {id: bc.id, namespace: bc.namespace, enabled: true, optional: false}, 
      children: [] };
  }

  function newBCProperty(property) {
    return {
      id: property.id, namespace: property.namespace, type: C_BC_ITEM, label: property.alias, ordinal: 0, 
      optional: property.optional, note: property.note, free_text: property.free_text, datatype: property.datatype,
      format: property.format, qText: property.qText, pText: property.pText, mapping: property.mapping,
      bridgPath: property.bridgPath, property_reference: {id: property.id, namespace: property.namespace, enabled: true}, 
      children: [] 
    };
  }

  function newBCPropertyCli(cli) {
    return {
      type: C_CL, 
      label: cli.notation, 
      ordinal: 0, 
      identifier: cli.property, 
      reference: {id: cli.id, namespace: cli.namespace, enabled: true, optional: false}, 
      children: [] 
    };
  }

  function newQuestionCli(cli) {
    return {
      type: C_CL, 
      label: cli.useful_1, 
      ordinal: 0, 
      identifier: cli.identifier, 
      reference: {id: cli.uri_id, namespace: cli.uri_ns, enabled: true, optional: false}, 
      children: [] 
    };
  }

  function addSourceNode(parent, node, end) {
    if (end) {
      parent.children.push(node);
    } else {
      parent.children.unshift(node);
    }
    //node.ordinal = parent.children.length;
    for (i=0; i<parent.children.length; i++) {
      temp = parent.children[i];
      temp.ordinal = i + 1;
    }
  }

  function addQuestion() {
    var sourceNode;
    var d3Node;
    var count;
    var label
    if (hasChildren(currentNode)) {
      count = currentNode.save.length + 1;
    } else {
      count = 1;
    }
    label = "Question" + count;
    sourceNode = newQuestion(label);
    d3Node = addD3Node(currentNode, label, C_QUESTION, sourceNode, true);     
    addSourceNode(currentNode.data, sourceNode, true)
    return d3Node;
  }

  function addPlaceholder() {
    var sourceNode;
    var d3Node;
    var count;
    var label
    if (hasChildren(currentNode)) {
      count = currentNode.save.length + 1;
    } else {
      count = 1;
    }
    label = "Placeholder" + count;
    sourceNode = newPlaceholder(label);
    d3Node = addD3Node(currentNode, label, C_PLACEHOLDER, sourceNode, true);     
    addSourceNode(currentNode.data, sourceNode, true)
    return d3Node;
  }

  function addBc() {
    var parentNode;
    var data = bcSelect.row(bcCurrentRow).data();
    
    bcNode = null;
    $.ajax({
      url: "/biomedical_concepts/" + data.id,
      data: {
        "id": data.id,
        "namespace": data.namespace
      },
      dataType: 'json',
      error: function (xhr, status, error) {
        var html = alertError("An error has occurred loading the Biomedical Concept.");
        displayAlerts(html);
      },
      success: function(result){
        var bc = $.parseJSON(JSON.stringify(result));
        var bcNode;
        var propertyNode;
        var cliNode;
        var sourceBcNode;
        var sourcePropertyNode;
        var sourceCliNode;
        var i;
        var j;
        sourceBcNode = newBCGroup(bc);
        bcNode = addD3Node(currentNode, bc.label, C_BC_GROUP, sourceBcNode, true);     
        addSourceNode(currentNode.data, sourceBcNode, true)
        for (i=0; i<bc.properties.length; i++) {
          //var property = bc.properties[i][1];
          var property = bc.properties[i];
          if (property.enabled && property.collect) {
            sourcePropertyNode = newBCProperty(property);
            propertyNode = addD3Node(bcNode, property.alias, C_BC_ITEM, sourcePropertyNode, true);     
            addSourceNode(sourceBcNode, sourcePropertyNode, true)
            var values = property.values
            for (j=0; j<values.length; j++) {
              var value = values[j];
              var cli = value.cli;
              sourceCliNode = newBCPropertyCli(cli);
              cliNode = addD3Node(propertyNode, cli.notation, C_CL, sourceCliNode, true); 
              cliNode.enabled = true    
              addSourceNode(sourcePropertyNode, sourceCliNode, true);
            }
          }
        }
        
        /* Now check for a common group and, if present, see if anything needs
        * moving.
        */
        /*if (hasCommon(currentNode)) {
          var item;
          var commonItem;
          var commonNode = currentNode.save[0];
          if (commonNode.hasOwnProperty('save')) {
            for (i=0; i<commonNode.save.length; i++) {
              commonItem = commonNode.save[i];
              for (j=0; j<bcNode.save.length; j++) {
                item = bcNode.save[j];
                if (item.bridgPath == commonItem.bridgPath) {
                  // Delete the item from its current position
                  item.realParent = item.parent;
                  bcNode.save.splice(item.index, 1);
                  //bcNode.children.splice(item.index, 1);
                  setParent(bcNode);
                  // And add to the common other nodes  
                  if (!commonNode.hasOwnProperty('otherCommon')) {
                    commonNode.otherCommon = [];
                  }
                  commonNode.otherCommon.push(item);
                }
              }
            }
          }
        }*/

        // And display everything.
        displayNode(currentNode);
        displayTree(currentNode.key);
      }
    });
  }

  /**
   *  Function to draw the tree
   */
  function displayTree(nodeKey) {
    treeNormal(d3Div, rootNode, click, dblClick);
    var gRef = findNode(nodeKey);
    currentGRef = gRef;
    currentNode = gRef.__data__;
    markNode1(currentGRef);    
  }
  
  function notImplementedYet() {
    var html = alertWarning("Function not implemented yet.");
    displayAlerts(html);
  }

  /*
  * Other utility functions
  */
  function handleBCTable(table, ref) {
    // Toggle the highlight for the row
    if (bcCurrent != null) {
      $(bcCurrent).toggleClass('success');
    }
    $(ref).toggleClass('success');

    // Get the row
    var row = table.row(ref).index();
    var data = table.row(row).data();

    // Save the selection
    bcCurrent = ref;
    bcCurrentRow = row;
  }

  function handleQuestionTable(table, ref) {
    // Toggle the highlight for the row
    if (varClCurrent != null) {
      $(varClCurrent).toggleClass('success');
    }
    $(ref).toggleClass('success');

    // Get the row
    var row = table.row(ref).index();
    var data = table.row(row).data();

    // Save the selection
    varClCurrent = ref;
    varClCurrentRow = row;
  }

  function initData () {
    
    // Get the JSON structure. Set the namespace of the thesauri.
    html = $("#formJson").html();
    formDefinition = $.parseJSON(html);
  
    markdownElement = null;
    markdownType = "";
    currentNode = null;
    currentGRef = null;
    bcCurrent = null;
    bcCurrentRow = null;
    notepadTableReload = false;
    notepadData = null;
    notepadRow = null; 
    varClCurrent = null;
    varClCurrentRow = null;
    questionDatatypeValue = "I";
    //setParent(formDefinition);
    //setSave(formDefinition);
    var managedItem = formDefinition.managed_item;
    rootNode = d3Root(managedItem.label, managedItem)
    nextKeyId = rootNode.key + 1;
    for (i=0; i<managedItem.children.length; i++) {
      child = managedItem.children[i];
      setD3(child, rootNode);
    }
    var operation = formDefinition.operation;
    editIdentifierFlag = operation.identifier_edit == true;
  }

  function setRoot() {
    displayTree(1);
    selectForm();
    displayForm(currentNode);
  }

  function setParent(node) {
    var i;
    var child;
    if (node.hasOwnProperty('save')) {
      for (i=0; i<node.save.length; i++) {
        child = node.save[i];
        child.parent = node;
        child.index = i;
        setParent(child);
      }
    }
  }

  function setOrdinal(node) {
    var i;
    var child;
    if (node.hasOwnProperty('children')) {
      for (i=0; i<node.children.length; i++) {
        child = node.children[i];
        child.ordinal = i+1;
      }
    }
  }

  /*function setSave(node) {
    if (node.hasOwnProperty('children')) {
      node.save = node.children;
      for (i=0; i<node.children.length; i++) {
        child = node.children[i];
        setSave(child);
      }
    }
  }*/

  function setD3(sourceNode, d3Node) {
    var newNode;
    var i;
    var child;
    if (sourceNode.type === C_GROUP || sourceNode.type === C_COMMON_GROUP || sourceNode.type === C_BC_GROUP || sourceNode.type === C_BC_ITEM || sourceNode.type === C_QUESTION) {
      newNode = addD3Node(d3Node, sourceNode.label, sourceNode.type, sourceNode, true);
      if (sourceNode.hasOwnProperty('children')) {
        for (i=0; i<sourceNode.children.length; i++) {
          child = sourceNode.children[i];
          setD3(child, newNode);
        }
      }
    } else if (sourceNode.type === C_PLACEHOLDER ) {
      newNode = addD3Node(d3Node, sourceNode.label, sourceNode.type, sourceNode, true);
    } else if (sourceNode.type === C_CL) {
      newNode = addD3Node(d3Node, sourceNode.label, sourceNode.type, sourceNode, true);
      value_ref = sourceNode.reference;
      newNode.enabled = value_ref.enabled;
    }
  }

  function addD3Node(parent, name, type, data, end) {
    var node = {};
    var temp;
    node.name = name;
    node.type = type;
    node.key = nextKeyId;
    node.parent = parent;
    node.data = data;
    node.expand = false;
    node.children = [];
    node.save = node.children;
    if (!parent.hasOwnProperty('save')) {
      parent.save = [];
      parent.children = [];
    }
    if (end) {
      node.index = parent.save.length;
      parent.save.push(node);
    } else {
      parent.save.unshift(node);
      for (i=0; i<parent.save.length; i++) {
        temp = parent.save[i];
        temp.index = i;
      }
    }
    parent.children = parent.save;
    nextKeyId += 1;
    return node;
  }

  function d3Root(name, data) {
    var node = {};
    node.name = name;
    node.type = C_FORM;
    node.key = 1;
    node.parent = null;
    node.data = data;
    node.expand = false;
    node.index = 0;
    node.children = [];
    node.save = node.children;
    return node;
  }

  function hasChildren(node) {
    var result = true;
    if (node.hasOwnProperty('save')) {
      if (currentNode.save.length == 0) {
        result = false;
      }
    } else {
      result = false;
    }
    return result;
  }

  function deleteNode(node) {
    var parentNode = node.parent
    var sourceParentNode = parentNode.data;
    var sourceNode = node.data;
    var parentIndex = node.index
    parentNode.save.splice(parentIndex, 1);
    sourceParentNode.children.splice(parentIndex, 1);
    if (parentNode.save.length == 0) {
      delete parentNode.children;
      delete parentNode.save;
      sourceParentNode.children = [];
    }
    setParent(parentNode);
    setOrdinal(sourceParentNode);
    return parentNode;
  }

  function moveNodeUp(node) {
    var parentNode = node.parent
    var parentIndex = node.index
    var sourceParentNode = parentNode.data;
    var sourceNode = node.data;
    if (parentIndex != 0 && parentNode.save.length > 1) {
      var tempNode1 = parentNode.save[parentIndex - 1];
      var tempNode2 = parentNode.save[parentIndex];
      parentNode.save[parentIndex - 1] = tempNode2;
      parentNode.save[parentIndex] = tempNode1;
      tempNode1.index = parentIndex;
      tempNode2.index = parentIndex - 1;
      tempNode1 = sourceParentNode.children[parentIndex - 1];
      tempNode2 = sourceParentNode.children[parentIndex];
      sourceParentNode.children[parentIndex - 1] = tempNode2;
      sourceParentNode.children[parentIndex] = tempNode1;
      tempNode1.index = parentIndex;
      tempNode2.index = parentIndex - 1;
      setOrdinal(sourceParentNode);
    }
  }

  function moveNodeDown(node) {
    var parentNode = node.parent
    var parentIndex = node.index
    var sourceParentNode = parentNode.data;
    var sourceNode = node.data;
    if (parentIndex != (parentNode.save.length - 1) && parentNode.save.length > 1) {
      var tempNode1 = parentNode.save[parentIndex + 1];
      var tempNode2 = parentNode.save[parentIndex];
      parentNode.save[parentIndex + 1] = tempNode2;
      parentNode.save[parentIndex] = tempNode1;
      tempNode1.index = parentIndex;
      tempNode2.index = parentIndex + 1;
      tempNode1 = sourceParentNode.children[parentIndex + 1];
      tempNode2 = sourceParentNode.children[parentIndex];
      sourceParentNode.children[parentIndex + 1] = tempNode2;
      sourceParentNode.children[parentIndex] = tempNode1;
      tempNode1.index = parentIndex;
      tempNode2.index = parentIndex + 1;
      setOrdinal(sourceParentNode);
    }
  }

  function displayNode(node) {
    if (node.type ==  C_FORM ) {
      selectForm();
      displayForm(node);
    } else if (node.type == C_GROUP) {
      selectGroup();
      displayGroup(node);
    } else if (node.type == C_BC_GROUP) {
      selectBC();
      displayBC(node);
    } else if (node.type == C_COMMON_GROUP) {
      selectCommon();
      displayCommon(node);
    } else if (node.type == C_BC_ITEM) {
      selectItem();
      displayItem(node);
    } else if (node.type == C_QUESTION) {
      questionClTable.clear();
      selectQuestion();
      displayQuestion(node);
      questionClTable.draw(false);
    } else if (node.type == C_PLACEHOLDER) {
      selectPlaceholder();
      displayPlaceholder(node);
    } else if (node.type == C_CL) {
      selectCl();
      displayCl(node);
    }
  }

  /*
  * Common node functions
  */
  function hasCommon(node) {
    if (hasChildren(node)) {
      child = node.save[0];
      if (child.type == C_COMMON_GROUP) {
        return true;
      } else {
        return false;
      }
    } else {
      return false;
    }  
  }

  function isCommon(node) {
    if (node.type == C_COMMON_GROUP) {
      return true;
    } else {
      return false;
    }
  }
  
  // TODO: Replace with generic version in forms.js
  function markdown() {
    $.ajax({
      url: "/forms/markdown",
      data: {
        "markdown": markdownElement.value
      },
      dataType: 'json',
      error: function (xhr, status, error) {
        var html = alertError("An error has occurred loading the markdown.");
        displayAlerts(html);
      },
      success: function(result){
        var html_text = $.parseJSON(JSON.stringify(result));
        genericCompletionElement.innerHTML = html_text.result;
      }
    });
  }

});