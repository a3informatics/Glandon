$(document).ready(function() {
  
  var formDefinition ;
  var formSave;
  var d3Div = document.getElementById("d3");
  var html  = $("#jsonData").html();
  var formIdentifierElement = document.getElementById("formIdentifier");
  var formLabelElement = document.getElementById("formLabel");
  var groupIdentifierElement = document.getElementById("groupIdentifier");
  var groupLabelElement = document.getElementById("groupLabel");
  var groupRepeatingElement = document.getElementById("groupRepeating");
  var commonIdentifierElement = document.getElementById("commonIdentifier");
  var commonLabelElement = document.getElementById("commonLabel");
  var bcIdentifierElement = document.getElementById("bcIdentifier");
  var bcLabelElement = document.getElementById("bcLabel");
  var itemIdentifierElement = document.getElementById("itemIdentifier");
  var itemLabelElement = document.getElementById("itemLabel");
  var itemEnableElement = document.getElementById("itemEnable");
  var clIdentifierElement = document.getElementById("clIdentifier");
  var clLabelElement = document.getElementById("clLabel");
  var clEnableElement = document.getElementById("clEnable");
  var plTextElement = document.getElementById("placeholderText");
  var questionTextElement = document.getElementById("questionText");
  var questionMappingElement = document.getElementById("questionMapping");
  var questionDatatypeElement = document.getElementById("questionDatatype");
  var questionFormatElement = document.getElementById("questionFormat");
  var alertsId = document.getElementById("alerts")
  
  var nextKeyId;
  var normal;
  var currentNode;
  var currentGRef;
  var bcCurrent;
  var bcCurrentRow;
  var termCurrent;
  var termCurrentRow;
  var varClCurrent;
  var varClCurrentRow;
  var questionDatatypeValue
  
  questionClTable = $('#questionClTable').DataTable({
    "searching": false,
    "pageLength": 5,
    "lengthChange": false,
    "columns": [
      {"data" : "identifier", "width" : "50%"},
      {"data" : "notation", "width" : "50%"},
    ]
  });
  questionClTable.clear();

  var bcSelect = $('#bcTable').DataTable( {
    "ajax": {
      "url": "../biomedical_concepts/list",
      "dataSrc": "data",
      error: function (xhr, status, error) {
        var html = alertError("An error has occurred loading the Biomedical Concepts table.");
        displayAlerts(html);
      }
    },
    dataType: 'json',
    "pageLength": 5,
    "lengthMenu": [[5, 10, 25, 50], [5, 10, 25, 50]],
    "pagingType": "full",
    "bProcessing": true,
    "language": {
      "infoFiltered": "",
      "processing": "<img src='<%= asset_path('processing.gif') %>'>"
    },
    "columns": [
      {"data" : "identifier", "width" : "50%"},
      {"data" : "label", "width" : "50%"}
    ]
  });

  var termSelect = document.getElementById("termSelect")
  var termInfo = termSelect.value;
  var parts = termInfo.split("|");
  var termTable = $('#termTable').DataTable( {
      "ajax": {
        "url": "../thesauri/searchNew",
        "data": function( d ) {
            d.id = parts[0],
            d.namespace = encodeURIComponent(parts[1])
          },
        "dataSrc": "data", 
        error: function (xhr, status, error) {
          var html = alertError("An error has occurred loading the Terminology table.");
          displayAlerts(html);
        }  
      },
      "pagingType": "full",
      "processing": true,
      "serverSide": true,
      "language": {
           "infoFiltered": "",
           "processing": "<img src='<%= asset_path('processing.gif') %>'>"
      },
      "pageLength": 5,
      "lengthMenu": [[5, 10, 25, 50], [5, 10, 25, 50]],
      "columns": [
          {"data" : "identifier", "width" : "50%"},
          {"data" : "notation", "width" : "50%"}
        ]
    });

  // Get the JSON structure. Set the namespace of the thesauri.
  formDefinition = $.parseJSON(html);
  initData();

  // Draw the initial tree and select the form.
  setRoot();

  /**
   * Function to handle click on the D3 tree.
   * Show the node info. Highlight the node.
   */
  function click(node) {    
    if (currentGRef != null) {
      clearNode(currentNode, currentGRef);
      if (currentNode.type == "Form") {
        saveForm(currentNode)
      } else if (currentNode.type == "Group") {
        saveGroup(currentNode)
      } else if (currentNode.type == "CommonGroup") {
        saveCommon(currentNode)
      } else if (currentNode.type == "Placeholder") {
        savePlaceholder(currentNode)
      }
    }
    displayNode(node)
    markNode1(this);
    currentGRef = this;
    currentNode = node;
  }  

  /**
   * Function to handle double click on the D3 tree.
   * Expand/delete the node clicked.
   */
  function dblClick(node) {
    var index;
    if (node.hasOwnProperty('children')) {
      node.children = [];
      node.expand = true;
      displayTree(node.key);
    } else if (node.hasOwnProperty('save')) {
      node.children = [];
      node.children = node.save;
      node.expand = false;
      displayTree(node.key);
    }
  } 

  /* 
  * Function to handle the form save click.
  */
  $('#formSave').click(function() {
    
    var formSave;

    // Copy the definition. Removes the circulart references and 
    // preserves the structure fo rfurther editing.
    formSave = {};
    copyNode(formDefinition, formSave);
    //alert("Data=" + JSON.stringify(formSave));

    // Send to the server
    $.ajax({
      url: "../forms",
      type: 'POST',
      data: { "form": formSave },
      success: function(result){
        var html = alertSuccess("Form has been saved.");
        displayAlerts(html);
      },
      error: function(xhr, status, error){
        var errors;
        var html;
        errors = $.parseJSON(xhr.responseText).errors;
        var html = ""
        for (var i=0; i<errors.length; i++) {
          html = html + alertError(errors[i]);
        }
        displayAlerts(html);
      }
    }); 

  });

  /*
   * Functions to handle the form actions.
   */
  $('#formUpdate').click(function() {
    if (currentGRef == null) {
      var html = alertWarning("You need to select the form node.");
      displayAlerts(html);
    } else {
      saveForm(currentNode);
      displayTree(currentNode.key);
    }
  });

  $('#formAddGroup').click(function() {
    if (currentGRef == null) {
      var html = alertWarning("You need to select the form node.");
      displayAlerts(html);
    } else {
      var node = addGroup();
      displayNode(node);
      displayTree(node.key);  
    }
  });

  /*
  * Functions to handle the group actions
  */
  $('#groupUpdate').click(function() {
    if (currentGRef == null) {
      var html = alertWarning("You need to select a group node.");
      displayAlerts(html);
    } else {
      saveGroup(currentNode)
      displayTree(currentNode.key);
    }
  });
  
  $('#groupAddGroup').click(function() {
    if (currentGRef == null) {
      var html = alertWarning("You need to select a group node.");
      displayAlerts(html);
    } else {
      var node = addGroup();
      displayNode(node);
      displayTree(node.key);  
    }
  });

  $('#groupDelete').click(function() {
    if (currentNode.hasOwnProperty('save')) {
      var html = alertWarning("You need to delete the child nodes.");
      displayAlerts(html);
    } else {
      var node = deleteNode(currentNode);
      displayNode(node);
      displayTree(node.key);
    }     
  });

  $('#groupAddCommon').click(function() {
    if (currentNode == null) {
      var html = alertWarning("You need to select a group node.");
      displayAlerts(html);
    } else if (hasCommon(currentNode)) {
      var html = alertWarning("Group already has a common node.");
      displayAlerts(html);
    } else {
      var node = addCommon();
      displayNode(node);
      displayTree(node.key);
    }
  }); 

  $('#groupAddBc').click(function() {
    if (currentNode == null) {
      var html = alertWarning("You need to select a group node.");
      displayAlerts(html);
    } else if (bcCurrent ==  null) {
      var html = alertWarning("You need to select a Biomedical Concept.");
      displayAlerts(html);
    } else {
      addBc();
    }
  }); 

  $('#groupAddQuestion').click(function() {
    if (currentNode == null) {
      var html = alertWarning("You need to select a group node.");
      displayAlerts(html);
    } else {
      node = addQuestion();
      displayNode(node);
      displayTree(node.key);
    }
  }); 

  $('#groupAddPlaceholder').click(function() {
    if (currentNode == null) {
      var html = alertWarning("You need to select a group node.");
      displayAlerts(html);
    } else {
      node = addPlaceholder();
      displayNode(node);
      displayTree(node.key);
    }
  }); 

  /*
  * Functions to handle the common actions
  */
  $('#commonUpdate').click(function() {
    if (currentGRef == null) {
      var html = alertWarning("You need to select a common node.");
      displayAlerts(html);
    } else {
      saveCommon(currentNode)
      displayTree(currentNode.key);
    }
  });
  
  $('#commonDelete').click(function() {
    if (currentNode.hasOwnProperty('save')) {
      var html = alertWarning("You need to remove the child nodes.");
      displayAlerts(html);
    } else {
      var node = deleteNode(currentNode);
      displayNode(node);
      displayTree(node.key);
    }     
  });

  /*
  * Functions to handle the placeholder actions
  */
  $('#questionUpdate').click(function() {
    if (currentGRef == null) {
      var html = alertWarning("You need to select a question node.");
      displayAlerts(html);
    } else {
      saveQuestion(currentNode)
      displayTree(currentNode.key);
    }
  });
  
  $('#questionDelete').click(function() {
    var node = deleteNode(currentNode);
    displayNode(node);
    displayTree(node.key);
  });

  /*
  * Functions to handle the placeholder actions
  */
  $('#placeholderUpdate').click(function() {
    if (currentGRef == null) {
      var html = alertWarning("You need to select a placeholder node.");
      displayAlerts(html);
    } else {
      savePlaceholder(currentNode)
      displayTree(currentNode.key);
    }
  });
  
  $('#placeholderDelete').click(function() {
    var node = deleteNode(currentNode);
    displayNode(node);
    displayTree(node.key);
  });

  /*
  * Functions to handle the BC actions
  */
  $('#bcDelete').click(function() {
    //var node = deleteNode(currentNode);
    //displayNode(node);
    //displayTree(node.key);
    notImplementedYet();     
  });

  /*
  * Functions to handle the item actions
  */
  $('#itemUpdate').click(function() {
    if (currentGRef == null) {
      var html = alertWarning("You need to select a group node.");
      displayAlerts(html);
    } else {
      saveItem(currentNode);
      displayTree(currentNode.key);
    }
  });
  
  $('#itemCommon').click(function() {
    if (currentNode == null) {
      var html = alertWarning("You need to select an item node.");
      displayAlerts(html);
    } else {
      makeCommon(currentNode);
    }
  }); 

  $('#itemRestore').click(function() {
    if (currentNode == null) {
      var html = alertWarning("You need to select an item node.");
      displayAlerts(html);
    } else {
      restoreCommon(currentNode);
      //notImplementedYet();
    }
  }); 

  /*
  * Functions to handle the code list items actions
  */
  $('#clUpdate').click(function() {
    if (currentNode == null) {
      var html = alertWarning("You need to select a group node.");
      displayAlerts(html);
    } else {
      saveCl(currentNode)
      displayTree(currentNode.key);
    }
  });
  
  /*
   * Function to handle click on the BC selection table.
   */
  $('#bcTable tbody').on('click', 'tr', function () {
    handleBCTable(bcSelect, this);
  });

  /*
   * Function to handle click on terminology table
   */
  $('#termTable tbody').on('click', 'tr', function () {
    handleTermTable(termTable, this);
  });

  /*
   * Function to handle click on question cl table
   */
  $('#questionClTable tbody').on('click', 'tr', function () {
    handleQuestionTable(questionClTable, this);
  });

  /* 
  * Function to handle the terminology button clicks.
  */
  $('#addTerm').click(function() {
    var data;
    if (termCurrentRow != null) {
      data = termTable.row(termCurrentRow).data();
      questionClTable.row.add(data);
      questionClTable.draw(false);
    }
  });

  $('#deleteTerm').click(function() {
    var data;
    if (varClCurrentRow != null) {
      questionClTable.row(varClCurrentRow).remove();
      varClCurrentRow = null;
      questionClTable.draw();
    }
  });

  $('#questionDatatype input:radio').click(function() {
    var value = $(this).val();
    clEnableDisable(value);
    questionDatatypeValue = value;
  });

  function clEnableDisable (value) {
    if (value == "I" || value == "C" || value == "F") {
      $("#questionFormat").prop('disabled', false);
      $("#addTerm").prop('disabled', true);
      $("#deleteTerm").prop('disabled', true);
    } else {
      $("#questionFormat").prop('disabled', true);
      $("#addTerm").prop('disabled', false);
      $("#deleteTerm").prop('disabled', false);
    }
  }

  /* ****************
  * Utility Functions
  */
  function selectForm() {
    clearSelect();
    $("#formInfo").removeClass('hidden');
  }

  function selectGroup() {
    clearSelect();
    $("#groupInfo").removeClass('hidden');
    $("#bcSelection").removeClass('hidden');
  }
  
  function selectBC() {
    clearSelect();
    $("#bcInfo").removeClass('hidden');
  }
  
  function selectCommon() {
    clearSelect();
    $("#commonInfo").removeClass('hidden');
  }
  
  function selectItem() {
    clearSelect();
    $("#itemInfo").removeClass('hidden');
  }

  function selectQuestion() {
    clearSelect();
    $("#questionInfo").removeClass('hidden');
    $("#termSelection").removeClass('hidden');
  }

  function selectPlaceholder() {
    clearSelect();
    $("#placeholderInfo").removeClass('hidden');
  }

  function selectCl() {
    clearSelect();
    $("#clInfo").removeClass('hidden');
  }

  function clearSelect() {
    $("#formInfo").addClass('hidden');
    $("#groupInfo").addClass('hidden');
    $("#bcInfo").addClass('hidden');
    $("#commonInfo").addClass('hidden');
    $("#questionInfo").addClass('hidden');
    $("#placeholderInfo").addClass('hidden');
    $("#itemInfo").addClass('hidden');
    $("#clInfo").addClass('hidden');
    $("#bcSelection").addClass('hidden');
    $("#termSelection").addClass('hidden');
  }

  /**
   * Functions to display the various panels. 
   */
  function displayForm(node) {
    formIdentifierElement.value = node.identifier;
    formLabelElement.value = node.label;
  }

  function displayGroup(node) {
    groupIdentifierElement.value = node.identifier;
    groupLabelElement.value = node.label;
    groupRepeatingElement.checked = node.repeating;
  }

  function displayBC(node) {
    bcIdentifierElement.innerHTML = node.identifier;
    bcLabelElement.innerHTML = node.label;
  }

  function displayCommon(node) {
    commonIdentifierElement.value = node.identifier;
    commonLabelElement.value = node.label;
  }

  function displayItem(node) {
    var parentNode;
    itemIdentifierElement.innerHTML = node.identifier;
    itemLabelElement.innerHTML = node.label;
    parentNode = node.parent;
    if (isCommon(parentNode)) {
      $("#itemEnable").prop('disabled', true);
      $("#itemUpdate").prop('disabled', true);
      $("#itemCommon").prop('disabled', true);
      $("#itemRestore").prop('disabled', false);
    } else {
      $("#itemEnable").prop('disabled', false);
      $("#itemUpdate").prop('disabled', false);
      $("#itemCommon").prop('disabled', false);
      $("#itemRestore").prop('disabled', true);
      itemEnableElement.checked = node.enabled;
    }
  }

  function displayQuestion(node) {
    questionTextElement.value = node.qText;
    questionMappingElement.value= node.mapping;
    var $radios = $('input:radio[name=dtRadio]');
    $radios.filter('[value=' + node.datatype +']').attr('checked', true);
    questionFormatElement.value = node.format;
    questionClTable.clear();
    if (node.hasOwnProperty('children')) {
      for (j=0; j<node.children.length; j++) {
        var row = node.children[j].cli;
        questionClTable.row.add(row);
      }
    }
    clEnableDisable(node.datatype);
  }

  function displayPlaceholder(node) {
    plTextElement.value = node.freeText;
  }

  function displayCl(node) {
    clIdentifierElement.innerHTML = node.identifier;
    clLabelElement.innerHTML = node.label;
    clEnableElement.checked = node.enabled;
  }

  /**
   * Functions to save info.
   */
  function saveForm(node) {
    node.identifier = formIdentifierElement.value;
    node.label = formLabelElement.value;
    node.name = node.label;
  }

  function saveGroup(node) {
    node.identifier = groupIdentifierElement.value;
    node.label = groupLabelElement.value;
    node.name = node.label;
    node.repeating = groupRepeatingElement.checked;

  }

  function saveCommon(node) {
    node.identifier = commonIdentifierElement.value;
    node.label = commonLabelElement.value;
    node.name = node.label;
  }

  function saveItem(node) {
    node.enabled = itemEnableElement.checked;
  }

  function saveQuestion(node) {
    var rowData;
    var i;
    var row;
    node.qText = questionTextElement.value;
    node.mapping = questionMappingElement.value;
    //node.datatype = questionDatatypeValue;
    node.datatype = $('input:radio[name=dtRadio]:checked').val();
    node.format = questionFormatElement.value;
    node.children = [];
    rowData = questionClTable.rows().data();
    for (i=0; i<rowData.length; i++) {
      row = rowData.row(i).data();
      if (typeof row != 'undefined') {
        node.children[i] = {};
        node.children[i].id = row.id;
        node.children[i].parent = node;
        node.children[i].namespace = row.namespace;
        node.children[i].name = row.notation;
        node.children[i].type = "QCL";
        node.children[i].identifier = row.identifier;
        node.children[i].index = i;
        node.children[i].label = row.notation;
        node.children[i].enabled = true;
        node.children[i].cli = row;
        node.children[i].key = nextKeyId;
        nextKeyId += 1;
      }
    }
    node.save = node.children;
  }

  function savePlaceholder(node) {
    node.freeText = plTextElement.value;
  }

  function saveCl(node) {
    node.enabled = clEnableElement.checked;
  }

  function makeCommon(node) {
    var child;
    var item;
    var commonGroup;
    var otherNodes = [];
    var bcParent = node.parent;
    var groupParent = bcParent.parent;
    if (bcParent != null && groupParent != null) {
      for (var i=0; i<groupParent.save.length; i++) {
        child = groupParent.save[i];
        if (child.type == 'CommonGroup') {
          commonGroup = child;
        } else if (child.type == 'BCGroup') {
          for (var j=0; j<child.save.length; j++) {
            item = child.save[j];
            if ('bridgPath' in item) {
              if (node.key == item.key) {
                // Same node, ignore.
              } else if (node.bridgPath == item.bridgPath) {
                otherNodes.push(item);

                // Delete the item from its current position
                item.realParent = item.parent;
                child.save.splice(item.index, 1);
                setParent(child);
              }
            }
          }
        }
      }
      if (commonGroup != null) {
        node.otherCommon = [];
        node.otherCommon = otherNodes
        if (!commonGroup.hasOwnProperty('save')) {
          commonGroup.children = [];
          commonGroup.save = [];
        }  
        commonGroup.children.push(node);
        commonGroup.save = commonGroup.children;

        // Delete the clicked-on node from current position.
        node.realParent = node.parent;
        //bcParent.children.splice(node.index, 1);
        bcParent.save.splice(node.index, 1);
        setParent(bcParent);

        // Display the tree. Will need to set the parents in the new common group.
        setParent(commonGroup);
        displayNode(commonGroup);
        displayTree(commonGroup.key);  

      } else {
        var html = alertWarning("Common group not found within this group.");
        displayAlerts(html);
      }
    } else {
      if (bcParent == null && groupParent == null) {
        var html = alertWarning("Something has gone wrong! Cannot find Biomedical Concept and the Group parent nodes.");
      } else if (bcParent == null) {
        var html = alertWarning("Something has gone wrong! Cannot find Biomedical Concept parent nodes.");
      } else if (groupParent == null) {
        var html = alertWarning("Something has gone wrong! Cannot find Group parent nodes.");
      }
      displayAlerts(html);
    }
  }

  function restoreCommon(node) {
    var item;
    var parentNode;
    var index;

    // Restore the 'other' nodes. These are the copies.
    for (i=0; i<node.otherCommon.length; i++) {
      item = node.otherCommon[i];
      parentNode = item.realParent
      index = item.index;
      parentNode.save.splice(index, 0, item);
    }

    // Restore the 'main' node.
    parentNode = node.realParent
    index = node.index;
    parentNode.save.splice(index, 0, node);

    // Delete the item from its current position and clean out the other
    // common nodes.
    node.otherCommon = [];
    deleteNode(node);

    // Draw the tree. Set the root as the selected node.
    setRoot();
  }

  function addCommon() {
    if (!currentNode.hasOwnProperty('save')) {
      currentNode.children = [];
      currentNode.save = [];
    }   
    var myHash = {};
    myHash.identifier = "New Common";
    myHash.name = "Common";
    myHash.label = "Common";
    myHash.type = "CommonGroup";
    myHash.parent = currentNode;
    myHash.index = 0;
    myHash.id = 'Not set';
    myHash.key = nextKeyId;
    nextKeyId += 1;
    currentNode.children.unshift(myHash);
    currentNode.save = currentNode.children;
    return currentNode.children[0];
  }

  /*
  * Group generic functions
  */
  function addGroup() {
    var index;
    if (currentNode.hasOwnProperty('save')) {
      index = currentNode.save.length;
    } else {
      currentNode.children = [];
      currentNode.save = [];
      index = 0;
    }     
    currentNode.children[index] = {};
    currentNode.children[index].identifier = "New Group";
    currentNode.children[index].name = "Group";
    currentNode.children[index].label = "Group";
    currentNode.children[index].type = "Group";
    currentNode.children[index].parent = currentNode;
    currentNode.children[index].index = index;
    currentNode.children[index].id = 'Not set';
    currentNode.children[index].key = nextKeyId;
    nextKeyId += 1;
    currentNode.save = currentNode.children;
    return currentNode.children[index];
  }

  function addQuestion() {
    var index;
    if (currentNode.hasOwnProperty('save')) {
      index = currentNode.save.length;
    } else {
      currentNode.children = [];
      currentNode.save = [];
      index = 0;
    }     
    var count = index + 1;
    currentNode.children[index] = {};
    currentNode.children[index].identifier = "Question" + count;
    currentNode.children[index].name = "Question " + count;
    currentNode.children[index].label = "Question " + count;
    currentNode.children[index].type = "Question";
    currentNode.children[index].parent = currentNode;
    currentNode.children[index].index = index;
    currentNode.children[index].id = "V" + count;
    currentNode.children[index].key = nextKeyId;
    currentNode.children[index].qText = "";
    currentNode.children[index].mapping = "";
    currentNode.children[index].datatype = "I";
    currentNode.children[index].format = "3";
    nextKeyId += 1;
    currentNode.save = currentNode.children;
    return currentNode.children[index];
  }

  function addPlaceholder() {
    var index;
    if (currentNode.hasOwnProperty('save')) {
      index = currentNode.save.length;
    } else {
      currentNode.children = [];
      currentNode.save = [];
      index = 0;
    }     
    var count = index + 1;
    currentNode.children[index] = {};
    currentNode.children[index].identifier = "Placeholder" + count;
    currentNode.children[index].name = "Placeholder " + count;
    currentNode.children[index].label = "Placeholder " + count;
    currentNode.children[index].type = "Placeholder";
    currentNode.children[index].parent = currentNode;
    currentNode.children[index].index = index;
    currentNode.children[index].id = "P" + count;
    currentNode.children[index].freeText = "";
    currentNode.children[index].key = nextKeyId;
    nextKeyId += 1;
    currentNode.save = currentNode.children;
    return currentNode.children[index];
  }

  function addBc() {
    var parentNode;
    var data = bcSelect.row(bcCurrentRow).data();
    
    bcNode = null;
    $.ajax({
      url: "../biomedical_concepts/" + data.id,
      data: {
        "id": data.id,
        "namespace": data.namespace
      },
      dataType: 'json',
      error: function (xhr, status, error) {
        var html = alertError("An error has occurred loading the Biomedical Concept.");
        displayAlerts(html);
      },
      success: function(result){
        var bc = $.parseJSON(JSON.stringify(result));
        var bcNode;
        var index;
        var pIndex;
        var cIndex;
        var i,j;
        if (currentNode.hasOwnProperty('save')) {
          index = currentNode.save.length;
        } else {
          currentNode.children = [];
          currentNode.save = [];
          index = 0;
        }     
        currentNode.children[index] = {};
        currentNode.children[index].id = bc.id;
        currentNode.children[index].parent = currentNode;
        currentNode.children[index].namespace = bc.namespace;
        currentNode.children[index].name = bc.label;
        currentNode.children[index].identifier = bc.identifier;
        currentNode.children[index].label = bc.label;
        currentNode.children[index].type = "BCGroup";
        currentNode.children[index].key = nextKeyId;
        currentNode.children[index].index = index;
        currentNode.children[index].children = [];
        bcNode = currentNode.children[index];
        nextKeyId += 1;
        pIndex = 0;
        for (i=0; i<bc.properties.length; i++) {
          var property = bc.properties[i];
          if (property[1].enabled && property[1].collect) {
            currentNode.children[index].children[pIndex] = {};
            currentNode.children[index].children[pIndex].id = property[1].id;
            currentNode.children[index].children[pIndex].parent = currentNode.children[index];
            currentNode.children[index].children[pIndex].namespace = property[1].namespace;
            currentNode.children[index].children[pIndex].name = property[1].alias;
            currentNode.children[index].children[pIndex].type = "Item";
            currentNode.children[index].children[pIndex].identifer = property[1].name;
            currentNode.children[index].children[pIndex].bridgPath = property[1].bridgPath;
            currentNode.children[index].children[pIndex].index = pIndex;
            currentNode.children[index].children[pIndex].label = property[1].alias;
            currentNode.children[index].children[pIndex].enabled = true;
            currentNode.children[index].children[pIndex].key = nextKeyId;
            nextKeyId += 1;
            var values = property[1].values
            for (var key in values) {
              var j=0
              object = values[key];
              var clis = object.clis;
              currentNode.children[index].children[pIndex].children = [];
              for (var cliKey in clis) {
                var cli = clis[cliKey];
                currentNode.children[index].children[pIndex].children[j] = {};
                currentNode.children[index].children[pIndex].children[j].id = cli.id;
                currentNode.children[index].children[pIndex].children[j].parent = currentNode.children[index].children[pIndex];
                currentNode.children[index].children[pIndex].children[j].namespace = cli.namespace;
                currentNode.children[index].children[pIndex].children[j].name = cli.notation;
                currentNode.children[index].children[pIndex].children[j].type = "CL";
                currentNode.children[index].children[pIndex].children[j].identifier = cli.identifier;
                currentNode.children[index].children[pIndex].children[j].index = j;
                currentNode.children[index].children[pIndex].children[j].label = cli.notation;
                currentNode.children[index].children[pIndex].children[j].enabled = true;
                currentNode.children[index].children[pIndex].children[j].key = nextKeyId;
                nextKeyId += 1;
                j += 1;
              }
              currentNode.children[index].children[pIndex].save = currentNode.children[index].children[pIndex].children;
            }
            pIndex++;
          }
        }
        currentNode.children[index].save = currentNode.children[index].children;
        currentNode.save = currentNode.children;
        
        /* Now check for a common group and, if present, see if anything needs
        * moving.
        */
        if (hasCommon(currentNode)) {
          var item;
          var commonItem;
          var commonNode = currentNode.save[0];
          if (commonNode.hasOwnProperty('save')) {
            for (i=0; i<commonNode.save.length; i++) {
              commonItem = commonNode.save[i];
              for (j=0; j<bcNode.save.length; j++) {
                item = bcNode.save[j];
                if (item.bridgPath == commonItem.bridgPath) {
                  // Delete the item from its current position
                  item.realParent = item.parent;
                  bcNode.save.splice(item.index, 1);
                  //bcNode.children.splice(item.index, 1);
                  setParent(bcNode);
                  // And add to the common other nodes  
                  if (!commonNode.hasOwnProperty('otherCommon')) {
                    commonNode.otherCommon = [];
                  }
                  commonNode.otherCommon.push(item);
                }
              }
            }
          }
        }

        // And display everything.
        displayNode(currentNode);
        displayTree(currentNode.key);
      }
    });
  }

  /**
   *  Function to draw the tree
   */
  function displayTree(nodeKey) {
    if (normal) {
      treeNormal(d3Div, formDefinition, click, dblClick);
    } else {
      treeCircular(d3Div, formDefinition, click, dblClick);
    }
    var gRef = findNode(nodeKey);
    currentGRef = gRef;
    currentNode = gRef.__data__;
    markNode1(currentGRef);    
  }
  
  function notImplementedYet() {
    var html = alertWarning("Function not implemented yet.");
    displayAlerts(html);
  }

  /*
  * Other utility functions
  */
  function handleBCTable(table, ref) {
    // Toggle the highlight for the row
    if (bcCurrent != null) {
      $(bcCurrent).toggleClass('success');
    }
    $(ref).toggleClass('success');

    // Get the row
    var row = table.row(ref).index();
    var data = table.row(row).data();

    // Save the selection
    bcCurrent = ref;
    bcCurrentRow = row;
  }

  function handleTermTable(table, ref) {
    // Toggle the highlight for the row
    if (termCurrent != null) {
      $(termCurrent).toggleClass('success');
    }
    $(ref).toggleClass('success');

    // Get the row
    var row = table.row(ref).index();
    var data = table.row(row).data();

    // Save the selection
    termCurrent = ref;
    termCurrentRow = row;
  }

  function handleQuestionTable(table, ref) {
    // Toggle the highlight for the row
    if (varClCurrent != null) {
      $(varClCurrent).toggleClass('success');
    }
    $(ref).toggleClass('success');

    // Get the row
    var row = table.row(ref).index();
    var data = table.row(row).data();

    // Save the selection
    varClCurrent = ref;
    varClCurrentRow = row;
  }

  function copyNode(sourceNode, targetNode) {
    var key;
    var i;
    for (key in sourceNode) {
      if (key == 'parent' || key == 'realParent' || key == 'children' || key == 'otherCommon' || key == 'save') {
      } else {
        targetNode[key] = sourceNode[key]
      }
    }
    if (sourceNode.hasOwnProperty('save')) {
      targetNode.children = [];
      for (i=0; i<sourceNode.save.length; i++) {
        //sourceChild = sourceNode.children[i];
        targetNode.children[i] = {}; 
        copyNode(sourceNode.save[i], targetNode.children[i]);
      }
    } else if (sourceNode.hasOwnProperty('otherCommon')) {
      targetNode.otherCommon = [];
      for (i=0; i<sourceNode.otherCommon.length; i++) {
        //sourceChild = sourceNode.children[i];
        targetNode.otherCommon[i] = {}; 
        copyNode(sourceNode.otherCommon[i], targetNode.otherCommon[i]);
      }
    }
  }

  function initData () {
    normal = true;
    currentNode = null;
    currentGRef = null;
    bcCurrent = null;
    bcCurrentRow = null;
    termCurrent = null;
    termCurrentRow = null;
    varClCurrent = null;
    varClCurrentRow = null;
    questionDatatypeValue = "I";
    nextKeyId = parseInt(formDefinition.nextKeyId); // 1 id the root node.
    setParent(formDefinition);
    setSave(formDefinition);
  }

  function setRoot() {
    displayTree(1);
    selectForm();
    displayForm(currentNode);
  }

  function setParent(node) {
    var i;
    var child;
    if (node.hasOwnProperty('save')) {
      for (i=0; i<node.save.length; i++) {
        child = node.save[i];
        child.parent = node;
        child.index = i;
        setParent(child);
      }
    }
  }

  function setSave(node) {
    if (node.hasOwnProperty('children')) {
      node.save = node.children;
      for (i=0; i<node.children.length; i++) {
        child = node.children[i];
        setSave(child);
      }
    }
  }

  function deleteNode(node) {
    var parentNode = node.parent
    var parentIndex = node.index
    parentNode.save.splice(parentIndex, 1);
    if (parentNode.save.length == 0) {
      delete parentNode.children;
      delete parentNode.save;
    }
    setParent(parentNode);
    return parentNode;
  }

  function displayNode(node) {
    if (node.type == "Form") {
      selectForm();
      displayForm(node);
    } else if (node.type == "Group") {
      selectGroup();
      displayGroup(node);
    } else if (node.type == "BCGroup") {
      selectBC();
      displayBC(node);
    } else if (node.type == "CommonGroup") {
      selectCommon();
      displayCommon(node);
    } else if (node.type == "Item") {
      selectItem();
      displayItem(node);
    } else if (node.type == "Question") {
      questionClTable.clear();
      selectQuestion();
      displayQuestion(node);
      questionClTable.draw(false);
    } else if (node.type == "Placeholder") {
      selectPlaceholder();
      displayPlaceholder(node);
    } else if (node.type == "CL") {
      selectCl();
      displayCl(node);
    }
  }

  /*
  * Common node functions
  */
  function hasCommon(node) {
    if (node.hasOwnProperty('save')) {
      child = node.save[0];
      if (child.type == 'CommonGroup') {
        return true;
      } else {
        return false;
      }
    } else {
      return false;
    }  
  }

  function isCommon(node) {
    if (node.type == 'CommonGroup') {
      return true;
    } else {
      return false;
    }
  }
  
});