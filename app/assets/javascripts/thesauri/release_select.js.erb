/*
* Release Select page
*
*
*/
$(document).ready(function(){
  var releaseSelect = new ReleaseSelect();
  var unload = new Unload(false);
});

/**
 * Release Select Constructor
 * This class is only a wrapper for code organization. It is page specific and should not be used elsewhere.
 *
 * @return [void]
 */
function ReleaseSelect(){
  this.timeline = this.initTS();
  this.cdiscCT = this.initCdiscCt();
  this.refThUrl = refThUrl;
  this.timer = new Timer($('#edit_lock_token').val(), "imh_header", $('#warning_timeout').val());

  this.tabs = this.initTabs();

  if(this.cdiscCT.versionId != null){
    this.tabs.cdiscTab.refresh(this.makeCdiscUrl(this.cdiscCT.versionId));
    $(".tab-option.disabled").removeClass("disabled");
  }
  this.setEventListeners();
}

/**
 * Initializes TimelineSlider
 *
 * @return [TimelineSlider]
 */
ReleaseSelect.prototype.initTS = function(){
  return new TimelineSlider($(".timeline-container"), $("#timeline-start-btn"), null, $(".timeline-point"));
}

/**
 * Initializes CDISC CT information. If none, defaults
 *
 * @return [Object] {version, versionId}
 */
ReleaseSelect.prototype.initCdiscCt = function(){
  var cdiscVer = $("#cdisc-version-label").text() == "None" ? null : $("#cdisc-version-label").text();
  var cdiscVerId = cdiscVer == null ? null : $(".timeline-point:contains("+cdiscVer+") span").attr("data-index");

  if (cdiscVer == null)
    cdiscVer = this.timeline.tl_points.eq(-1).children().first().html();

  return {version: cdiscVer, versionId: cdiscVerId};
}

/**
 * Generates URL string for CDISC data fetching based on CT id
 * @param [String] terminology ID
 *
 * @return [String] URL to fetch CDISC CT version children
 */
ReleaseSelect.prototype.makeCdiscUrl = function(id){
  return cdiscCLUrl.replace("th_id", id)
}

/**
 * Initializes all the tabs on the page
 *
 * @return [Object] of tab references {cdiscTab, ...}
 */
ReleaseSelect.prototype.initTabs = function(){
  var overviewUrls = {dataUrl: sponsorCLUrl, selectUrl: selectChildrenURL, deselectUrl: deselectChildrenUrl, deselectAllUrl: deselectAllChildrenUrl};
  var overview = new ManagedChildrenSelectOverview(overviewUrls, "#table-selection-overview", 1000, this);
  var cdiscCls = new ManagedChildrenSelect("", "#table-cdisc-cls", 1000, overview, "thCodeList").init().setListeners();
  var sponsorCls = new ManagedChildrenSelect(sponsorCLUrl, "#table-sponsor-cls", 1000, overview, "thCodeList").init().setListeners();

  return {cdiscTab: cdiscCls, sponsorClTab: sponsorCls, target: overview};
}

/**
 * Calls auto select on each tab
 *
 * @return [void]
 */
ReleaseSelect.prototype.autoDeselectAllTabs = function(data){
  var _this = this;
  $.each(_this.tabs, function(k,v){
    if(k != "target")
      v.autoDeselect(data);
  });
}


/**
 * Changes CDISC version, reloads data, updates UI
 *
 * @return [void]
 */
ReleaseSelect.prototype.changeCdiscVer = function(){
  this.cdiscCT.versionId = $(".timeline-point.point-highlight span").attr("data-index");
  this.cdiscCT.version = $(".timeline-point.point-highlight span").first().text();

  this.refThUpdate();
}

/**
 * Sets the referenced thesaurus to a CDISC version
 *
 * @return [void]
 */
ReleaseSelect.prototype.refThUpdate = function(){
  this.tabs.cdiscTab.processing(true);

  $.ajax({
    url: this.refThUrl,
    data: {thesauri: {thesaurus_id: this.cdiscCT.versionId}},
    type: 'PUT',
    dataType: 'json',
    context: this,
    success: function (result) {
      this.tabs.cdiscTab.processing(false);

      $("#cdisc-version-label").html(this.cdiscCT.version);
      this.tabs.target.updateItems(this.tabs.target.mcs.findRowsByParam("owner", {owner: "CDISC"}), {thisTable: true}, "remove");
      this.tabs.cdiscTab.refresh(this.makeCdiscUrl(this.cdiscCT.versionId));
      $(".tab-option.disabled").removeClass("disabled");
      $(".show-more-btn").click();
    },
    error: function (xhr, status, error) {
			handleAjaxError(xhr, status, error);
			this.tabs.cdiscTab.processing(false);
		}
  })
}

/**
 * Sets various event handlers on the page
 *
 * @return [void]
 */
ReleaseSelect.prototype.setEventListeners = function(){
  var _this = this;

  $(".card-with-tabs .show-more-btn").one("change", function(){
    _this.timeline.moveToDate(_this.timeline.l_slider, _this.cdiscCT.version);
    $(".timeline-container").data(_this.timeline);
  });

  $("#select-cdisc-ver-button").on("click", function(){
    if ($(".timeline-point.point-highlight span").text() == $("#cdisc-version-label").html())
      return;
    else if (_this.cdiscCT.versionId == null)
      _this.changeCdiscVer();
    else
      new ConfirmationDialog(function(){ _this.changeCdiscVer(); },
        {subtitle: "If you change CDISC version, all CDISC codelists will be cleared from your thesaurus. This operation cannot be undone.",
        dangerous: true})
      .show();
  });

  tabSwitchCallback = function(tab){
    switch($(tab).attr("id")){
      case "tab-sponsor-cls":
        if(!_this.tabs.sponsorClTab.dataLoaded){
          var loadCallback = function(){_this.tabs.sponsorClTab.autoSelect.bind(_this.tabs.sponsorClTab)()};
          _this.tabs.sponsorClTab.loadData(0, loadCallback);
        }
          break;
    }
  }
}
