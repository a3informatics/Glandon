/*
* Release Select page
*
*
*/
$(document).ready(function(){
  new ReleaseSelect();
});

/**
 * Release Select Constructor
 * This class is only a wrapper for code organization. It is page specific and should not be used elsewhere.
 *
 * @return [void]
 */
function ReleaseSelect(){
  this.timeline = this.initTS();
  this.cdiscCT = this.initCdiscCt();

  this.tabs = this.initTabs();

  if(this.cdiscCT.versionId != null){
    this.tabs.cdiscTab.refresh(this.makeCdiscUrl(this.cdiscCT.versionId));
    $(".tab-option.disabled").removeClass("disabled");
  }

  this.setEventListeners();
}

/**
 * Initializes TimelineSlider
 *
 * @return [TimelineSlider]
 */
ReleaseSelect.prototype.initTS = function(){
  return new TimelineSlider($(".timeline-container"), $("#timeline-start-btn"), null, $(".timeline-point"));
}

/**
 * Initializes CDISC CT information. If none, defaults
 *
 * @return [Object] {version, versionId}
 */
ReleaseSelect.prototype.initCdiscCt = function(){
  var cdiscVer = $("#cdisc-version-label").text() == "None" ? null : $("#cdisc-version-label").text();
  var cdiscVerId = cdiscVer == null ? null : $(".timeline-point:contains("+cdiscVer+") span").attr("data-index");

  if (cdiscVer == null)
    cdiscVer = this.timeline.tl_points.eq(-1).children().first().html();

  return {version: cdiscVer, versionId: cdiscVerId};
}

/**
 * Generates URL string for CDISC data fetching based on CT id
 * @param [String] terminology ID
 *
 * @return [String] URL to fetch CDISC CT version children
 */
ReleaseSelect.prototype.makeCdiscUrl = function(id){
  return cdiscCLUrl.replace("th_id", id)
}

/**
 * Initializes all the tabs on the page
 *
 * @return [Object] of tab references {cdiscTab, ...}
 */
ReleaseSelect.prototype.initTabs = function(){
  var overview = new ManagedChildrenSelectOverview(sponsorCLUrl, "#table-selection-overview", 1000, this);
  var cdiscCls = new ManagedChildrenSelect("", "#table-cdisc-cls", 1000, overview, "thCodeList").init().setListeners();
  var sponsorCls = new ManagedChildrenSelect(sponsorCLUrl, "#table-sponsor-cls", 1000, overview, "thCodeList").init().setListeners();

  return {cdiscTab: cdiscCls, sponsorClTab: sponsorCls, target: overview};
}

/**
 * Calls auto select on each tab
 *
 * @return [void]
 */
ReleaseSelect.prototype.autoDeselectAllTabs = function(data){
  var _this = this;
  $.each(_this.tabs, function(k,v){
    if(k != "target")
      v.autoDeselect(data);
  });
}


/**
 * Changes CDISC version, reloads data, updates UI
 *
 * @return [void]
 * TODO: Make call to save CT change, clear CDISC data from selection tab
 */
ReleaseSelect.prototype.changeCdiscVer = function(){
  this.cdiscCT.versionId = $(".timeline-point.point-highlight span").attr("data-index");
  this.cdiscCT.version = $(".timeline-point.point-highlight span").text();

  this.tabs.cdiscTab.refresh(this.makeCdiscUrl(this.cdiscCT.versionId));
  $("#cdisc-version-label").html(this.cdiscCT.version);
  $(".tab-option.disabled").removeClass("disabled");
  $(".show-more-btn").click();

  this.tabs.target.mcs.findRowsByParam("owner", {owner: "CDISC"}).remove();
  this.tabs.target.redraw();
}

/**
 * Sets various event handlers on the page
 *
 * @return [void]
 */
ReleaseSelect.prototype.setEventListeners = function(){
  var _this = this;

  $(".card-with-tabs .show-more-btn").on("change", function(){
    _this.timeline.moveToDate(_this.timeline.l_slider, _this.cdiscCT.version);
  });

  $("#select-cdisc-ver-button").on("click", function(){
    if ($(".timeline-point.point-highlight span").text() == $("#cdisc-version-label").html())
      return;
    new ConfirmationDialog(function(){ _this.changeCdiscVer(); },
      {subtitle: "If you change CDISC version, all CDISC codelists will be cleared from your thesaurus. This operation cannot be undone.", dangerous: true}).show();
  });

  tabSwitchCallback = function(tab){
   switch($(tab).attr("id")){
     case "tab-sponsor-cls":
      if(!_this.tabs.sponsorClTab.dataLoaded)
         _this.tabs.sponsorClTab.loadData(0);
       break;
     default:
       break;
   }
  }
}
